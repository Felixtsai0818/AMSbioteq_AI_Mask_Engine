<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Mask Engine (AMS BioteQ Co., Ltd.)</title>
    
    <!-- 核心函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Tailwind 設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        yiyu: {
                            base: '#2D4A3E',    // AMS BioteQ 基調色 (深苔綠)
                            primary: '#5F8D75', // 主色
                            secondary: '#A3B18A', // 次要色
                            accent: '#D0E1D4',   // 點綴色
                            bg: '#F9F8F6',       // 全局背景
                            text: '#2C3333',     // 主要文字
                            danger: '#EF4444'    // 警示色
                        }
                    },
                    fontFamily: {
                        sans: ['Helvetica Neue', 'Arial', 'sans-serif'],
                        serif: ['Georgia', 'serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* 全局樣式 */
        body { background-color: theme('colors.yiyu.bg'); color: theme('colors.yiyu.text'); }
        
        /* 側邊欄 */
        .sidebar { background: linear-gradient(180deg, #2D4A3E 0%, #1B352C 100%); color: white; }
        .logo-section { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .subtitle { font-family: 'Georgia', serif; font-style: italic; font-size: 0.7rem; color: #A3B18A; letter-spacing: 0.8px; margin-top: 6px; opacity: 0.9; }
        
        /* 導航 */
        .nav-item { padding: 16px 20px; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; color: #A3B18A; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(95, 141, 117, 0.15); border-left-color: #5F8D75; color: #fff; font-weight: 500; }
        
        /* UI 元件 */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(45, 74, 62, 0.04); padding: 24px; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid rgba(163, 177, 138, 0.15); }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(45, 74, 62, 0.08); border-color: rgba(95, 141, 117, 0.3); }
        
        .tag-select { cursor: pointer; border: 1px solid #A3B18A; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; color: #5F8D75; transition: 0.2s; background: white; }
        .tag-select:hover { background: #F0F5F2; border-color: #5F8D75; }
        .tag-select.selected { background: #5F8D75; color: white; border-color: #5F8D75; box-shadow: 0 2px 5px rgba(95, 141, 117, 0.3); }
        
        /* 動畫與其他 */
        .chart-container { position: relative; height: 300px; width: 100%; }
        .animate-fade-in { animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #A3B18A; border-radius: 3px; }

        /* PDF 匯出專用樣式 (修正空白頁問題) */
        #pdf-container {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: #2C3333;
            background: white;
            position: fixed; 
            top: 0;
            left: -10000px; /* 移出畫面但保持渲染 */
            width: 794px; /* A4 寬度 */
            z-index: 99999;
            visibility: visible;
        }
        
        /* 當我們加上 .show-pdf 類別時，讓它顯示出來 (如果需要除錯) */
        #pdf-container.show-pdf {
            visibility: visible;
        }

        .pdf-page {
            width: 100%;
            min-height: 1123px;
            padding: 40px;
            box-sizing: border-box;
            border: 2px solid #2D4A3E; 
            position: relative;
            background: white;
            margin-bottom: 0;
        }
        .pdf-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2D4A3E; padding-bottom: 15px; margin-bottom: 25px; }
        .pdf-footer { margin-top: 30px; padding-top: 10px; border-top: 1px solid #eee; text-align: center; font-size: 10px; color: #666; position: absolute; bottom: 40px; left: 40px; right: 40px; }
        .pdf-section-title { background: #2D4A3E; color: white; padding: 5px 10px; font-size: 14px; font-weight: bold; margin-bottom: 15px; display: inline-block; }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px; }
        .pdf-table th { background: #f0f5f2; padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #2D4A3E; }
        .pdf-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .pdf-product { display: flex; align-items: start; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .pdf-product img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 100000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm md:text-base">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-3xl mb-4"><i class="fas fa-spinner fa-spin"></i></div>
        <div class="text-lg font-bold">Generating PDF Report...</div>
        <div class="text-sm opacity-80">Please wait a moment</div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar w-20 md:w-64 flex-shrink-0 flex flex-col shadow-2xl z-20">
        <div class="logo-section flex flex-col">
            <img src="logo.png" alt="AMS BioteQ" class="w-32 md:w-40 mb-2 object-contain h-auto" onerror="this.src='https://placehold.co/200x60/2D4A3E/FFFFFF?text=AMS+BioteQ'">
            <div class="subtitle">the art of micro-ecology balance</div>
        </div>
        <nav class="mt-6 flex-1 px-2 space-y-2">
            <div class="nav-item active rounded" onclick="switchTab('lab', this)">
                <div class="flex items-center gap-3">
                    <i class="fas fa-flask text-lg w-6 text-center"></i>
                    <span class="hidden md:block" data-i18n="nav_lab">配方開發實驗室</span>
                </div>
            </div>
            <div class="nav-item rounded" onclick="switchTab('market', this)">
                <div class="flex items-center gap-3">
                    <i class="fas fa-chart-line text-lg w-6 text-center"></i>
                    <span class="hidden md:block" data-i18n="nav_market">市場趨勢洞察</span>
                </div>
            </div>
            <div class="nav-item rounded" onclick="switchTab('products', this)">
                <div class="flex items-center gap-3">
                    <i class="fas fa-database text-lg w-6 text-center"></i>
                    <span class="hidden md:block" data-i18n="nav_assets">企業配方資產</span>
                </div>
            </div>
        </nav>
        <div class="p-6 text-xs text-gray-400 opacity-60 hidden md:block border-t border-white/10">
            AMS System V7.5 (Stable)<br>Module: Lab & Market
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto bg-yiyu-bg p-4 md:p-8 relative">
        
        <!-- Top Bar -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 sticky top-0 bg-yiyu-bg/95 backdrop-blur z-10 py-3 border-b border-gray-200/50">
            <div>
                <h1 id="pageTitle" class="text-2xl font-bold text-yiyu-base tracking-tight" data-i18n="title_lab">配方開發實驗室</h1>
                <p id="pageDesc" class="text-gray-500 text-xs md:text-sm mt-1" data-i18n="desc_lab">微生態平衡導向的 AI 面膜企劃引擎</p>
            </div>
            <div class="flex gap-3 bg-white p-2 rounded-lg shadow-sm border border-gray-100 items-center">
                <button onclick="exportToPDF()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded shadow flex items-center gap-2 text-xs md:text-sm transition-colors cursor-pointer">
                    <i class="fas fa-file-pdf"></i>
                    <span data-i18n="btn_export_pdf">Export PDF</span>
                </button>
                <div class="w-px h-6 bg-gray-200 mx-1"></div>
                <div class="flex items-center gap-2 px-3 border-r border-gray-200">
                    <i class="fas fa-globe text-yiyu-primary"></i>
                    <select id="langSelect" class="bg-transparent font-bold text-gray-600 outline-none cursor-pointer text-sm" onchange="changeLanguage(this.value)">
                        <option value="zh-TW">繁體中文</option>
                        <option value="en-US">English</option>
                        <option value="ja-JP">日本語</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 px-3">
                    <i class="fas fa-coins text-yellow-600"></i>
                    <select id="currency" class="bg-transparent font-bold text-gray-600 outline-none cursor-pointer text-sm" onchange="updateSystemCurrency()">
                        <option value="TWD">TWD ($)</option>
                        <option value="JPY">JPY (¥)</option>
                        <option value="USD">USD ($)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- TAB: LAB -->
        <div id="tab-lab" class="animate-fade-in space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Left Controls -->
                <div class="lg:col-span-3 space-y-6">
                    <div class="card border-l-4 border-yiyu-primary">
                        <h3 class="font-bold text-yiyu-base mb-4 text-xs uppercase tracking-widest border-b pb-2 border-gray-100 flex justify-between">
                            <span data-i18n="sect_sales">0. 銷售渠道與定價</span>
                            <i class="fas fa-store text-yiyu-secondary"></i>
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1" data-i18n="lbl_channel">選擇銷售渠道</label>
                                <select id="salesChannel" class="w-full p-2 bg-gray-50 border border-gray-200 rounded text-sm outline-none focus:border-yiyu-primary" onchange="recalc()">
                                    <option value="own" data-i18n="opt_own">自有品牌官網 (DTC)</option>
                                    <option value="retail" data-i18n="opt_retail">實體通路/上架 (Retail)</option>
                                    <option value="distributor" data-i18n="opt_dist">經銷代理 (Distributor)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1" data-i18n="lbl_price">單片預計售價 (末端)</label>
                                <div class="flex items-center">
                                    <span class="bg-gray-100 p-2 rounded-l text-gray-500 text-sm" id="currencySymbol">$</span>
                                    <input type="number" id="retailPrice" value="50" class="w-full p-2 border border-gray-200 rounded-r text-sm outline-none focus:border-yiyu-primary text-right" onchange="recalc()">
                                </div>
                            </div>
                            <div class="bg-gray-100 p-3 rounded text-xs text-gray-600">
                                <span data-i18n="lbl_target_cost">目標成本上限 (COGS):</span> <br>
                                <span id="targetCostDisplay" class="text-lg font-bold text-yiyu-primary">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="font-bold text-yiyu-base mb-4 text-xs uppercase tracking-widest border-b pb-2 border-gray-100 flex justify-between">
                            <span data-i18n="sect_claims">1. 核心訴求 Claims</span>
                            <i class="fas fa-check-double text-yiyu-secondary"></i>
                        </h3>
                        <div class="flex flex-wrap gap-2" id="claimsContainer"></div>
                    </div>

                    <div class="card">
                        <h3 class="font-bold text-yiyu-base mb-4 text-xs uppercase tracking-widest border-b pb-2 border-gray-100 flex justify-between">
                            <span data-i18n="sect_fabric">2. 膜布載體 Fabric</span>
                            <i class="fas fa-layer-group text-yiyu-secondary"></i>
                        </h3>
                        <select id="fabricSelect" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm mb-2 outline-none focus:border-yiyu-primary focus:ring-1 focus:ring-yiyu-primary" onchange="recalc()"></select>
                        <p id="fabricDesc" class="text-xs text-gray-500 italic mt-1 pl-1">...</p>
                    </div>

                    <div class="card bg-gradient-to-br from-[#E8F3EB] to-[#F5F9F6] border border-[#CDE5D6] shadow-none">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 rounded-full bg-yiyu-primary flex items-center justify-center text-white text-xs shadow-sm"><i class="fas fa-robot"></i></div>
                            <h3 class="font-bold text-yiyu-base text-sm" data-i18n="sect_ai">AI 智囊</h3>
                        </div>
                        <div id="aiSuggestion" class="text-xs text-gray-700 leading-relaxed min-h-[40px] font-medium" data-i18n="ai_waiting">等待輸入核心訴求...</div>
                    </div>
                </div>

                <!-- Middle Formula -->
                <div class="lg:col-span-5">
                    <div class="card h-full flex flex-col border-t-4 border-t-yiyu-base">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-yiyu-base" data-i18n="sect_structure">配方架構</h3>
                            <span class="text-xs font-mono bg-yiyu-secondary/20 text-yiyu-base px-2 py-1 rounded font-bold">Total: <span id="totalPct">0</span>%</span>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <select id="ingredientSelector" class="flex-1 p-2 bg-gray-50 border border-gray-200 rounded text-sm outline-none focus:border-yiyu-primary focus:ring-1 focus:ring-yiyu-primary">
                                <option value="" data-i18n="opt_add_ing">+ 選擇活性成分...</option>
                            </select>
                            <button onclick="addIngredient()" class="bg-yiyu-primary hover:bg-yiyu-base text-white w-10 h-10 rounded shadow-md transition-all flex items-center justify-center"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto bg-gray-50 rounded border border-gray-100 p-1">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-gray-400 border-b border-gray-200 bg-gray-100/50 sticky top-0">
                                    <tr><th class="p-2 text-left pl-3">INCI Name</th><th class="p-2 text-right w-16">%</th><th class="p-2 text-right w-20" data-i18n="col_cost">Cost</th><th class="p-2 w-8"></th></tr>
                                </thead>
                                <tbody id="formulaBody">
                                    <tr class="bg-blue-50/30">
                                        <td class="p-3 font-medium text-yiyu-base flex items-center gap-2"><i class="fas fa-tint text-blue-300"></i> WATER</td>
                                        <td class="p-3 text-right text-gray-600" id="waterPct">100.0</td>
                                        <td class="p-3 text-right text-gray-400">-</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 bg-gray-50/50 p-3 rounded-lg">
                            <div class="flex justify-between items-end mb-2">
                                <div class="text-xs text-gray-500 font-medium uppercase tracking-wide" data-i18n="lbl_actual_cost">Actual Cost<br>(Per Sheet)</div>
                                <div class="text-3xl font-bold text-yiyu-primary currency-val tracking-tight" id="finalCost">0</div>
                            </div>
                            <div id="costWarning" class="hidden bg-red-50 border border-red-200 text-red-600 p-2 rounded text-xs flex items-center gap-2 animate-pulse">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span><span data-i18n="msg_warning">警告：超出目標成本</span> <span id="overCostAmount" class="font-bold"></span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Charts -->
                <div class="lg:col-span-4">
                    <div class="card h-full flex flex-col">
                        <h3 class="font-bold text-yiyu-base mb-2 text-xs uppercase tracking-widest flex items-center gap-2">
                            <span data-i18n="sect_efficacy">3. 效能預測 Efficacy</span>
                            <i class="fas fa-chart-radar text-yiyu-secondary"></i>
                        </h3>
                        <div class="chart-container flex-1">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: MARKET -->
        <div id="tab-market" class="hidden animate-fade-in space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card lg:col-span-2">
                    <h3 class="font-bold text-yiyu-base mb-4 flex items-center gap-2">
                        <i class="fas fa-crosshairs text-yiyu-primary"></i> 
                        <span data-i18n="sect_pos_map">市場定位象限圖 (Positioning Map)</span>
                    </h3>
                    <div class="chart-container h-80">
                        <canvas id="marketMapChart"></canvas>
                    </div>
                </div>
                <div class="card bg-gradient-to-b from-white to-gray-50 border border-gray-100 flex flex-col">
                    <h3 class="font-bold text-yiyu-base mb-4 flex items-center gap-2">
                        <i class="fas fa-brain text-yiyu-primary"></i> 
                        <span data-i18n="sect_sentiment">AI 輿情洞察 (Sentiment)</span>
                    </h3>
                    <div class="space-y-4 flex-1 overflow-y-auto pr-1">
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                            <div class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider flex justify-between">
                                <span data-i18n="lbl_keywords">消費者熱議關鍵字</span>
                                <span class="text-yiyu-primary text-[10px] bg-yiyu-primary/10 px-2 rounded-full" id="currentFocus">--</span>
                            </div>
                            <div class="flex flex-wrap gap-2" id="marketKeywords">
                                <span class="text-xs text-gray-400" data-i18n="msg_select_claim">請先在實驗室選擇核心訴求...</span>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                            <div class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider" data-i18n="lbl_gap">市場缺口 (GAP Analysis)</div>
                            <p class="text-xs text-gray-600 leading-relaxed" id="marketGap">
                                <i class="fas fa-search text-gray-300 mr-1"></i>
                                <span data-i18n="msg_waiting_param">系統正等待配方參數輸入以進行分析...</span>
                            </p>
                        </div>
                        <div class="bg-yiyu-primary/5 p-3 rounded-lg border border-yiyu-primary/20">
                            <div class="text-xs text-yiyu-primary font-bold mb-1" data-i18n="lbl_strategy">建議定價策略</div>
                            <p class="text-xs text-gray-700 leading-relaxed" id="marketStrategy">--</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Competitor Table (Restored) -->
            <div class="card">
                <h3 class="font-bold text-yiyu-base mb-4 flex items-center gap-2">
                    <i class="fas fa-list-ul text-yiyu-primary"></i> 
                    <span data-i18n="sect_competitors">競品詳細規格對比</span>
                </h3>
                <div class="overflow-x-auto border border-gray-100 rounded-lg">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <tr>
                                <th class="p-3 pl-4">Brand</th>
                                <th class="p-3" data-i18n="col_claim">Core Claim</th>
                                <th class="p-3" data-i18n="col_ingredients">Key Ingredients</th>
                                <th class="p-3" data-i18n="col_feedback">User Feedback (AI Summary)</th>
                                <th class="p-3 text-right pr-4" data-i18n="col_retail_price">Est. Retail Price</th>
                            </tr>
                        </thead>
                        <tbody id="competitorTable" class="divide-y divide-gray-100 bg-white">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: PRODUCTS -->
        <div id="tab-products" class="hidden animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productGrid"></div>
        </div>

    </div>

    <!-- PDF Template Container -->
    <div id="pdf-container"></div>

    <script>
        // --- DATA & CONFIG ---
        const exchangeRates = {
            'TWD': { rate: 1, symbol: 'NT$', unit: 'TWD' },
            'JPY': { rate: 4.5, symbol: '¥', unit: 'JPY' },
            'USD': { rate: 0.031, symbol: '$', unit: 'USD' }
        };
        let currentLang = 'zh-TW';
        let currentCurrency = 'TWD';
        let formula = [];
        let activeClaims = [];
        let radarChart, marketMapChart;

        // 全域定義，確保連動邏輯可讀取
        const insightsDB = {
            'oil': {
                focus: { "zh-TW": '控油/油痘肌', "en-US": 'Oil Control/Acne', "ja-JP": '皮脂ケア/ニキビ肌' },
                keywords: { 
                    "zh-TW": ['#清爽不黏', '#毛孔收斂', '#去油光', '#不致粉刺', '#鎮靜退紅'],
                    "en-US": ['#Non-Sticky', '#PoreRefining', '#MatteFinish', '#Non-Comedogenic', '#Calming'],
                    "ja-JP": ['#さっぱり', '#毛穴引き締め', '#テカリ防止', '#ノンコメド', '#鎮静']
                },
                gap: { 
                    "zh-TW": '目前市場缺乏「高單價且具修護力」的控油產品，多數產品過於廉價且刺激。',
                    "en-US": 'Market lacks premium oil-control products with repair benefits; most are cheap and harsh.',
                    "ja-JP": '高級かつ修復力のある皮脂ケア製品が不足しています。多くは安価で刺激が強いです。'
                },
                strategy: { 
                    "zh-TW": '建議強調「酸類溫和煥膚」與「屏障修護」並重，切入中高階市場。',
                    "en-US": 'Emphasize "Gentle Acid Peeling" + "Barrier Repair" to target the premium segment.',
                    "ja-JP": '「マイルドピーリング」と「バリア修復」を強調し、中高級市場を狙うことを推奨します。'
                }
            },
            'moist': {
                focus: { "zh-TW": '保濕/乾肌', "en-US": 'Hydration/Dry Skin', "ja-JP": '保湿/乾燥肌' },
                keywords: { 
                    "zh-TW": ['#爆水感', '#長效鎖水', '#不悶痘', '#妝前急救', '#滲透快'],
                    "en-US": ['#BurstingWater', '#LongLasting', '#Breathable', '#Pre-Makeup', '#FastAbsorb'],
                    "ja-JP": ['#水光肌', '#長時間保湿', '#閉塞感なし', '#化粧ノリ', '#高浸透']
                },
                gap: { 
                    "zh-TW": '保濕市場飽和，缺口在於「針對極端氣候」或「醫美術後」的高機能保濕。',
                    "en-US": 'Market saturated. Opportunity in "Extreme Climate" or "Post-Procedure" hydration.',
                    "ja-JP": '保湿市場は飽和状態。「極端な気候」や「施術後」向けの高機能保湿にチャンスあり。'
                },
                strategy: { 
                    "zh-TW": '避開價格戰，改走「成分黨」路線，強調多重玻尿酸或神經醯胺的高濃度添加。',
                    "en-US": 'Avoid price wars. Target "Ingredient Junkies" with high-conc. Ceramides/Hyaluronic Acid.',
                    "ja-JP": '価格競争を避け、「成分重視」層に向け、高濃度セラミドやヒアルロン酸をアピール。'
                }
            },
            'white': {
                focus: { "zh-TW": '美白/暗沉', "en-US": 'Brightening/Dullness', "ja-JP": '美白/くすみ' },
                keywords: {
                    "zh-TW": ['#提亮有感', '#淡化痘印', '#不反黑', '#溫和亮白', '#發光肌'],
                    "en-US": ['#Glow', '#FadeSpots', '#Non-Darkening', '#GentleBrightening', '#Radiance'],
                    "ja-JP": ['#トーンアップ', '#ニキビ跡ケア', '#低刺激', '#透明感', '#発光肌']
                },
                gap: {
                    "zh-TW": '消費者害怕美白成分刺激，缺乏「敏感肌也能用的高效美白」產品。',
                    "en-US": 'Consumers fear irritation. Lack of "Effective Brightening for Sensitive Skin".',
                    "ja-JP": '美白成分の刺激が懸念点。「敏感肌でも使える高機能美白」が不足。'
                },
                strategy: {
                    "zh-TW": '結合舒緩成分 (積雪草) 與美白成分，主打「溫和高效」。',
                    "en-US": 'Combine soothing agents (Cica) with brighteners. Claim "Gentle & Effective".',
                    "ja-JP": '鎮静成分（CICA）と美白成分を組み合わせ、「優しく高効果」を訴求。'
                }
            },
            'aging': {
                focus: { "zh-TW": '抗老/熟齡', "en-US": 'Anti-Aging', "ja-JP": 'エイジングケア' },
                keywords: {
                    "zh-TW": ['#撫平細紋', '#緊緻拉提', '#澎潤感', '#改善法令紋', '#熬夜神器'],
                    "en-US": ['#AntiWrinkle', '#Lifting', '#Plumping', '#LineReduction', '#NightRepair'],
                    "ja-JP": ['#シワ改善', '#リフトアップ', '#ハリ感', '#ほうれい線', '#徹夜対策']
                },
                gap: {
                    "zh-TW": '開架市場缺乏真正含有有效濃度 (如 PDRN, 胜肽) 的抗老面膜。',
                    "en-US": 'Mass market lacks anti-aging masks with effective concentrations (PDRN, Peptides).',
                    "ja-JP": 'ドラッグストア市場には、有効濃度（PDRN、ペプチド等）を含む製品が不足。'
                },
                strategy: {
                    "zh-TW": '使用高單價膜布 (生物纖維/微導)，配合高濃度活性物，打造旗艦級產品。',
                    "en-US": 'Use premium fabric (Bio-cellulose) + high actives for a flagship product.',
                    "ja-JP": '高級シート（バイオセルロース等）と高濃度成分で、フラッグシップ製品を構築。'
                }
            },
            'repair': {
                focus: { "zh-TW": '修護/敏感', "en-US": 'Repair/Sensitive', "ja-JP": '修復/敏感肌' },
                keywords: {
                    "zh-TW": ['#退紅神速', '#舒緩乾癢', '#增厚角質', '#無酒精', '#換季救星'],
                    "en-US": ['#FastRednessRelief', '#SootheItch', '#BarrierBuild', '#AlcoholFree', '#SeasonalHelp'],
                    "ja-JP": ['#赤み鎮静', '#痒み緩和', '#バリア強化', '#アルコールフリー', '#季節の変わり目']
                },
                gap: {
                    "zh-TW": '針對「口罩肌」或「刷酸後」的修護需求持續上升，但專用產品不多。',
                    "en-US": 'Rising demand for "Maskne" or "Post-Acid" repair, but few dedicated products.',
                    "ja-JP": '「マスク荒れ」や「ピーリング後」の需要増だが、専用製品は少ない。'
                },
                strategy: {
                    "zh-TW": '強調「極簡配方」與「無添加」，建立專業醫美形象。',
                    "en-US": 'Emphasize "Minimalist Formula" & "Free-From" to build a Derma-cosmetic image.',
                    "ja-JP": '「ミニマル処方」と「無添加」を強調し、ドクターズコスメのイメージを確立。'
                }
            }
        };

        const fabricsDB = [
            { id: "veocel", cost: 3.0, stats: { moist: 5, white: 1, aging: 0, repair: 2, oil: 0 }, 
              name: { "zh-TW": "水凝絲面膜 (VEOCEL Lyocell)", "en-US": "Hydra Silk (VEOCEL Lyocell)", "ja-JP": "ハイドラシルク (VEOCEL)" },
              desc: { "zh-TW": "8um 極薄，高載液量，果凍般膚感。", "en-US": "8um ultra-thin, high capacity, jelly-like texture.", "ja-JP": "8um極薄、高保水力、ゼリーのような質感。" } },
            { id: "plant", cost: 1.5, stats: { moist: 3, white: 0, aging: 0, repair: 1, oil: 0 }, 
              name: { "zh-TW": "超柔感面膜 (Plant Fiber)", "en-US": "Soft Touch (Plant Fiber)", "ja-JP": "ソフトタッチ (植物繊維)" },
              desc: { "zh-TW": "高透氣、高柔軟度，親民入門款。", "en-US": "High breathability, soft, entry-level choice.", "ja-JP": "高通気性、高柔軟性、エントリーモデル。" } },
            { id: "tencel", cost: 2.0, stats: { moist: 4, white: 1, aging: 0, repair: 1, oil: 0 }, 
              name: { "zh-TW": "輕透絲面膜 (Tencel)", "en-US": "Lite Silk (Tencel)", "ja-JP": "ライトシルク (テンセル)" },
              desc: { "zh-TW": "堅韌絲滑，吸水性佳，宛如第二層肌膚。", "en-US": "Strong & silky, good absorption, second-skin feel.", "ja-JP": "強靭で滑らか、高吸収性、第二の肌のような感触。" } },
            { id: "pet3d", cost: 2.5, stats: { moist: 2, white: 0, aging: 4, repair: 1, oil: 0 }, 
              name: { "zh-TW": "提拉彈力面膜 (PET 3D)", "en-US": "Lifting 3D Mask", "ja-JP": "リフティング3Dマスク" },
              desc: { "zh-TW": "獨特螺旋結構，雙向拉力，物理提拉效果。", "en-US": "Spiral structure, two-way stretch, physical lifting.", "ja-JP": "独自の螺旋構造、双方向ストレッチ、物理的リフトアップ。" } },
            { id: "nano", cost: 2.8, stats: { moist: 4, white: 1, aging: 2, repair: 3, oil: 0 }, 
              name: { "zh-TW": "奈米長纖面膜 (Nano PET)", "en-US": "Nano Fiber Mask", "ja-JP": "ナノファイバーマスク" },
              desc: { "zh-TW": "2um 奈米纖維，磁鐵般貼合，高強度韌性。", "en-US": "2um nano fiber, magnet-like fit, high tenacity.", "ja-JP": "2umナノ繊維、磁石のような密着力、高靭性。" } },
            { id: "charcoal", cost: 2.0, stats: { moist: 1, white: 1, aging: 0, repair: 0, oil: 5 }, 
              name: { "zh-TW": "竹炭面膜 (Bamboo Charcoal)", "en-US": "Bamboo Charcoal Mask", "ja-JP": "竹炭ブラックマスク" },
              desc: { "zh-TW": "高溫鍛燒天然黑，吸附髒汙，淨化毛孔。", "en-US": "Natural charcoal, absorbs dirt, purifies pores.", "ja-JP": "天然竹炭、汚れ吸着、毛穴浄化。" } },
            { id: "hydrogel", cost: 12.0, stats: { moist: 5, white: 2, aging: 5, repair: 4, oil: 0 }, 
              name: { "zh-TW": "微導凝膠膜 (Hydrogel)", "en-US": "Hydrogel Mask", "ja-JP": "ハイドロゲルマスク" },
              desc: { "zh-TW": "高單價，深層導入，適合高階抗老產品。", "en-US": "Premium, deep penetration, for anti-aging.", "ja-JP": "高単価、深層浸透、高級エイジングケア向け。" } }
        ];

        const ingredients = [
            { name: "Butylene Glycol", cost: 120, stats: { moist: 2, white: 0, aging: 0, repair: 0, oil: 0 }, tags:['all'] },
            { name: "Niacinamide (B3)", cost: 850, stats: { moist: 1, white: 5, aging: 2, repair: 3, oil: 3 }, tags:['white','oil','aging'] },
            { name: "Azelaic Acid", cost: 2800, stats: { moist: 0, white: 3, aging: 0, repair: 0, oil: 5 }, tags:['oil'] },
            { name: "Tea Tree Oil", cost: 3200, stats: { moist: 0, white: 0, aging: 0, repair: 2, oil: 5 }, tags:['oil','repair'] },
            { name: "PDRN (DNA-Na)", cost: 15000, stats: { moist: 2, white: 0, aging: 5, repair: 5, oil: 0 }, tags:['aging','repair'] },
            { name: "Centella Asiatica", cost: 1800, stats: { moist: 1, white: 0, aging: 0, repair: 5, oil: 1 }, tags:['repair'] },
            { name: "Vit C (Ethyl Ascorbic)", cost: 4500, stats: { moist: 0, white: 5, aging: 3, repair: 0, oil: 0 }, tags:['white'] },
            { name: "Ceramide Complex", cost: 6500, stats: { moist: 4, white: 0, aging: 2, repair: 5, oil: 0 }, tags:['repair','moist'] },
            { name: "Sodium Hyaluronate", cost: 3000, stats: { moist: 5, white: 0, aging: 1, repair: 1, oil: 0 }, tags:['moist'] },
            { name: "Hexapeptide-8", cost: 12000, stats: { moist: 1, white: 0, aging: 5, repair: 0, oil: 0 }, tags:['aging'] }
        ];

        const productsDB = [
            { name: { "zh-TW": "淨光平衡面膜", "en-US": "Pure Balance Mask", "ja-JP": "ピュアバランスマスク" }, key: "Azelaic Acid + Tea Tree", desc: { "zh-TW": "微生態控油平衡系統，接觸空氣自動產生細緻泡泡。", "en-US": "Micro-ecology balance. Self-foaming upon air contact.", "ja-JP": "美肌菌バランス。空気に触れると自動発泡する技術。" }, img: "淨光.jpg" },
            { name: { "zh-TW": "恆光逆齡面膜", "en-US": "Ageless Glow Mask", "ja-JP": "エイジレスグロウマスク" }, key: "PDRN + Peptides", desc: { "zh-TW": "深層賦活緊緻配方，提升肌膚彈力與保水感。", "en-US": "Deep revitalizing formula. Boosts elasticity & moisture.", "ja-JP": "深層活性化処方。ハリと保水力を高める。" }, img: "恆光.jpg" },
            { name: { "zh-TW": "柔光修護面膜", "en-US": "Soft Repair Mask", "ja-JP": "ソフトリペアマスク" }, key: "CICA + Ceramide", desc: { "zh-TW": "舒緩修護屏障強韌，專為不穩定膚況設計。", "en-US": "Soothing barrier repair. For unstable skin conditions.", "ja-JP": "鎮静バリア修復。不安定な肌コンディション向け。" }, img: "柔光.jpg" },
            { name: { "zh-TW": "極光煥白面膜", "en-US": "Aurora White Mask", "ja-JP": "オーロラホワイトマスク" }, key: "Vit C + Glutathione", desc: { "zh-TW": "肌膚透亮光澤對策，改善膚色不均。", "en-US": "Radiance solution. Improves uneven skin tone.", "ja-JP": "透明感対策。肌の色ムラを改善。" }, img: "極光.jpg" },
            { name: { "zh-TW": "勻光整肌面膜", "en-US": "Radiance Mask", "ja-JP": "ラディアンスマスク" }, key: "Collagen + HA", desc: { "zh-TW": "基礎滋潤柔嫩，使肌膚呈現平滑細緻感。", "en-US": "Essential hydration for smooth and refined texture.", "ja-JP": "基礎保湿。滑らかでキメの細かい肌へ。" }, img: "勻光.jpg" }
        ];

        const competitorsDB = [
            { b: "Anua (KR)", p: "Azelaic Acid 15", k: "Azelaic, CICA", price: 25, volume: 85, cat: { "zh-TW": "控油調理", "en-US": "Oil Control", "ja-JP": "皮脂ケア" }, fb: { "zh-TW": "鎮靜效果快，但精華液偏少。", "en-US": "Fast calming, but low serum amount.", "ja-JP": "鎮静は早いが、美容液が少なめ。" } },
            { b: "Lululun (JP)", p: "Hydra-F", k: "Charcoal, Fullerene", price: 28, volume: 95, cat: { "zh-TW": "毛孔緊緻", "en-US": "Pore Firming", "ja-JP": "毛穴引き締め" }, fb: { "zh-TW": "備長炭布膜服貼，CP值高。", "en-US": "Charcoal sheet fits well. High CP value.", "ja-JP": "炭シートが密着。コスパ高い。" } },
            { b: "Quality 1st", p: "Super VC100", k: "Vit C, Nanocapsules", price: 25, volume: 90, cat: { "zh-TW": "亮白毛孔", "en-US": "Brightening", "ja-JP": "美白毛穴" }, fb: { "zh-TW": "稍微有刺激感，敏感肌慎用。", "en-US": "Slight tingling, caution for sensitive skin.", "ja-JP": "少しピリつく、敏感肌は注意。" } },
            { b: "Medicube", p: "PDRN Pink", k: "PDRN, Collagen", price: 120, volume: 40, cat: { "zh-TW": "高階修護", "en-US": "Adv. Repair", "ja-JP": "高度修復" }, fb: { "zh-TW": "效果驚人但價格偏高，適合急救。", "en-US": "Amazing results but pricey. Good for SOS.", "ja-JP": "効果は凄いが高い。救急用に。" } },
            { b: "Torriden (KR)", p: "DIVE IN", k: "5D Hyaluronic", price: 60, volume: 75, cat: { "zh-TW": "深層保濕", "en-US": "Deep Moist", "ja-JP": "深層保湿" }, fb: { "zh-TW": "非常溫和，適合所有膚質。", "en-US": "Very gentle, suitable for all skin types.", "ja-JP": "非常にマイルド、全肌質対応。" } }
        ];

        const translations = {
            'zh-TW': {
                nav_lab: "配方開發實驗室", nav_market: "市場趨勢洞察", nav_assets: "企業配方資產",
                title_lab: "配方開發實驗室", desc_lab: "微生態平衡導向的 AI 面膜企劃引擎",
                btn_export_pdf: "匯出 PDF",
                sect_sales: "0. 銷售渠道與定價", lbl_channel: "選擇銷售渠道", opt_own: "自有品牌官網 (DTC)", opt_retail: "實體通路/上架 (Retail)", opt_dist: "經銷代理 (Distributor)",
                lbl_price: "單片預計售價 (末端)", lbl_target_cost: "目標成本上限 (COGS):",
                sect_claims: "1. 核心訴求 Claims", sect_fabric: "2. 膜布載體 Fabric",
                sect_ai: "AI 智囊", ai_waiting: "等待輸入核心訴求...",
                sect_structure: "配方架構", opt_add_ing: "+ 選擇活性成分...", col_cost: "Cost", lbl_actual_cost: "實際成本 (Per Sheet)", msg_warning: "警告：超出目標成本",
                sect_efficacy: "3. 效能預測 Efficacy",
                sect_pos_map: "市場定位象限圖 (Positioning Map)", sect_sentiment: "AI 輿情洞察 (Sentiment)", lbl_keywords: "消費者熱議關鍵字", lbl_gap: "市場缺口 (GAP Analysis)", msg_waiting_param: "系統正等待配方參數輸入...", lbl_strategy: "建議定價策略",
                sect_competitors: "競品詳細規格對比", col_claim: "主訴求", col_ingredients: "關鍵成分", col_feedback: "用戶反饋 (AI摘要)", col_retail_price: "預估售價",
                claims: { oil: "控油平衡", moist: "高效保濕", white: "透亮煥白", aging: "緊緻撫紋", repair: "屏障修護" },
                radar_labels: ['保濕', '美白', '抗老', '修護', '控油'],
                map_x: "價格", map_y: "市場聲量",
                // PDF
                print_page_title1: "配方開發實驗室報告", print_page_title2: "企業配方資產", print_section1: "配方企劃概要", print_section2: "已上市產品線", ai_prefix: "AI 推薦成分: "
            },
            'en-US': {
                nav_lab: "Formula Lab", nav_market: "Market Insights", nav_assets: "Enterprise Assets",
                title_lab: "Formula Development Lab", desc_lab: "Micro-ecology Balance AI Engine",
                btn_export_pdf: "Export PDF",
                sect_sales: "0. Sales Channel & Pricing", lbl_channel: "Select Sales Channel", opt_own: "DTC (Official Site)", opt_retail: "Retail Stores", opt_dist: "Distributors",
                lbl_price: "Est. Retail Price (Unit)", lbl_target_cost: "Target COGS Limit:",
                sect_claims: "1. Core Claims", sect_fabric: "2. Fabric Carrier",
                sect_ai: "AI Insights", ai_waiting: "Waiting for input...",
                sect_structure: "Formula Structure", opt_add_ing: "+ Add Active Ingredient...", col_cost: "Cost", lbl_actual_cost: "Actual Cost (Per Sheet)", msg_warning: "Warning: Exceeds Target Cost",
                sect_efficacy: "3. Efficacy Prediction",
                sect_pos_map: "Market Positioning Map", sect_sentiment: "AI Sentiment Analysis", lbl_keywords: "Consumer Keywords", lbl_gap: "Market Gap Analysis", msg_waiting_param: "Waiting for formula parameters...", lbl_strategy: "Pricing Strategy",
                sect_competitors: "Competitor Specs Comparison", col_claim: "Core Claim", col_ingredients: "Key Ingredients", col_feedback: "User Feedback (AI)", col_retail_price: "Est. Price",
                claims: { oil: "Oil Control", moist: "Hydration", white: "Brightening", aging: "Anti-Aging", repair: "Repairing" },
                radar_labels: ['Moist', 'White', 'Anti-Aging', 'Repair', 'Oil Ctrl'],
                map_x: "Price", map_y: "Market Volume",
                // PDF
                print_page_title1: "Formula Lab Report", print_page_title2: "Product Assets", print_section1: "Formula Planning Overview", print_section2: "Launched Product Line", ai_prefix: "AI Suggests: "
            },
            'ja-JP': {
                nav_lab: "処方開発ラボ", nav_market: "市場トレンド分析", nav_assets: "製品資産",
                title_lab: "処方開発ラボ", desc_lab: "美肌菌バランス指向 AI 企画エンジン",
                btn_export_pdf: "PDF エクスポート",
                sect_sales: "0. 販売チャネルと価格設定", lbl_channel: "販売チャネル選択", opt_own: "自社EC (DTC)", opt_retail: "実店舗 (Retail)", opt_dist: "代理店 (Distributor)",
                lbl_price: "予想小売価格 (単価)", lbl_target_cost: "目標原価上限 (COGS):",
                sect_claims: "1. コア訴求 Claims", sect_fabric: "2. シート素材 Fabric",
                sect_ai: "AI インサイト", ai_waiting: "訴求を選択してください...",
                sect_structure: "処方構成", opt_add_ing: "+ 有効成分を追加...", col_cost: "コスト", lbl_actual_cost: "実原価 (Per Sheet)", msg_warning: "警告：目標コスト超過",
                sect_efficacy: "3. 効能予測",
                sect_pos_map: "市場ポジショニングマップ", sect_sentiment: "AI 口コミ分析", lbl_keywords: "注目のキーワード", lbl_gap: "市場ギャップ分析", msg_waiting_param: "分析パラメータの入力待ち...", lbl_strategy: "推奨価格戦略",
                sect_competitors: "競合製品スペック比較", col_claim: "訴求", col_ingredients: "キー成分", col_feedback: "ユーザー評価 (AI要約)", col_retail_price: "予想価格",
                claims: { oil: "皮脂ケア", moist: "高保湿", white: "美白・透明感", aging: "エイジングケア", repair: "バリア修復" },
                radar_labels: ['保湿', '美白', 'エイジング', '修復', '皮脂'],
                map_x: "価格", map_y: "市場ボリューム",
                // PDF
                print_page_title1: "処方ラボレポート", print_page_title2: "製品資産", print_section1: "処方企画概要", print_section2: "発売済み製品ライン", ai_prefix: "AI 推奨成分: "
            }
        };

        // --- CORE FUNCTIONS ---
        window.onload = function() {
            initCharts();
            populateSelect();
            changeLanguage('zh-TW'); // Init with TW
            document.getElementById('fabricSelect').value = "0"; 
            recalc();
            updateMarketMap();
        };

        function changeLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];

            // 1. Static Text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) el.innerText = t[key];
            });

            // 2. Select Options (Sales Channel)
            const channelSelect = document.getElementById('salesChannel');
            Array.from(channelSelect.options).forEach(opt => {
                const key = 'opt_' + opt.value;
                if (t[key]) opt.innerText = t[key];
            });

            // 3. Dynamic Renders
            populateFabricSelect();
            renderClaims();
            renderProducts();
            renderMarketTable();
            updateAiSuggestion();
            updateMarketInsights();
            updateChartsLang();
            recalc();
        }

        function switchTab(id, el) {
            document.querySelectorAll('[id^="tab-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            const t = translations[currentLang];
            // Update Title/Desc based on tab
            if(id === 'lab') { document.getElementById('pageTitle').innerText = t.title_lab; document.getElementById('pageDesc').innerText = t.desc_lab; }
            if(id === 'market') { document.getElementById('pageTitle').innerText = t.nav_market; document.getElementById('pageDesc').innerText = t.desc_lab; } // Use generic desc or specific? Using lab desc as per original request or similar
            if(id === 'products') { document.getElementById('pageTitle').innerText = t.nav_assets; document.getElementById('pageDesc').innerText = t.desc_assets; }

            // Refresh Chart
            if (id === 'market' && marketMapChart) {
                setTimeout(() => { marketMapChart.resize(); marketMapChart.update(); }, 50);
            }
        }

        function populateFabricSelect() {
            const sel = document.getElementById('fabricSelect');
            const currentVal = sel.value || "0";
            sel.innerHTML = fabricsDB.map((f, i) => `<option value="${i}">${f.name[currentLang]}</option>`).join('');
            sel.value = currentVal;
            document.getElementById('fabricDesc').innerText = fabricsDB[sel.value || 0].desc[currentLang];
        }

        function renderClaims() {
            const t = translations[currentLang];
            const container = document.getElementById('claimsContainer');
            container.innerHTML = ['oil', 'moist', 'white', 'aging', 'repair'].map(k => 
                `<span class="tag-select ${activeClaims.includes(k) ? 'selected' : ''}" onclick="toggleClaim(this, '${k}')">${t.claims[k]}</span>`
            ).join('');
        }

        function toggleClaim(el, claim) {
            el.classList.toggle('selected');
            if(activeClaims.includes(claim)) activeClaims = activeClaims.filter(c=>c!==claim);
            else activeClaims.push(claim);
            updateAiSuggestion();
            updateMarketInsights();
        }

        function updateAiSuggestion() {
            const t = translations[currentLang];
            const box = document.getElementById('aiSuggestion');
            if(activeClaims.length === 0) { box.innerText = t.ai_waiting; return; }
            let hits = ingredients.filter(ing => activeClaims.some(c => ing.tags.includes(c)));
            let uniqueHits = [...new Set(hits.map(h => h.name.split(' ')[0]))];
            box.innerHTML = `${t.ai_prefix}<span class="font-bold text-yiyu-primary">${uniqueHits.join(', ')}</span>`;
        }

        function updateMarketInsights() {
            const t = translations[currentLang];
            const kwContainer = document.getElementById('marketKeywords');
            const gapContainer = document.getElementById('marketGap');
            const stratContainer = document.getElementById('marketStrategy');
            const focusLabel = document.getElementById('currentFocus');

            if(activeClaims.length === 0) {
                focusLabel.innerText = "--";
                kwContainer.innerHTML = `<span class="text-xs text-gray-400">${t.ai_waiting}</span>`;
                gapContainer.innerHTML = `<i class="fas fa-search text-gray-300 mr-1"></i> ${t.msg_waiting_param}`;
                stratContainer.innerText = "--";
                return;
            }

            const mainClaim = activeClaims[activeClaims.length - 1];
            const data = insightsDB[mainClaim];

            if(data) {
                focusLabel.innerText = data.focus[currentLang];
                let kwHtml = '';
                const colors = ['bg-red-50 text-red-600', 'bg-blue-50 text-blue-600', 'bg-green-50 text-green-600', 'bg-purple-50 text-purple-600'];
                data.keywords[currentLang].forEach((k, i) => {
                    let colorClass = colors[i % colors.length];
                    kwHtml += `<span class="text-xs ${colorClass} px-2 py-1 rounded border border-opacity-50">${k}</span>`;
                });
                kwContainer.innerHTML = kwHtml;
                gapContainer.innerHTML = `<strong class="text-yiyu-secondary">Analysis:</strong> ${data.gap[currentLang]}`;
                stratContainer.innerHTML = data.strategy[currentLang];
            }
        }

        function renderProducts() {
            document.getElementById('productGrid').innerHTML = productsDB.map(p => `
                <div class="card border-t-4 border-yiyu-primary cursor-pointer hover:-translate-y-1 transition-all">
                    <img src="${p.img}" alt="${p.name[currentLang]}" class="w-full h-48 object-cover rounded-md mt-3 mb-2" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2D4A3E/FFFFFF?text=Image+Not+Found'">
                    <h3 class="font-bold text-yiyu-base text-lg">${p.name[currentLang]}</h3>
                    <p class="text-xs text-gray-500 mt-2">${p.desc[currentLang]}</p>
                    <p class="mt-4 pt-4 border-t text-xs text-gray-400">Key: ${p.key}</p>
                </div>`).join('');
        }

        function renderMarketTable() {
            const tbody = document.getElementById('competitorTable');
            const rate = exchangeRates[currentCurrency];
            tbody.innerHTML = competitorsDB.map(c => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                    <td class="p-3 pl-4 font-medium text-gray-700">${c.b}<div class="text-xs text-gray-400">${c.p}</div></td>
                    <td class="p-3"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium">${c.cat[currentLang]}</span></td>
                    <td class="p-3 text-xs text-yiyu-primary font-bold">${c.k}</td>
                    <td class="p-3 text-xs text-gray-500 italic">"${c.fb[currentLang]}"</td>
                    <td class="p-3 text-right pr-4 font-mono font-bold text-gray-600">${rate.symbol}${(c.price*rate.rate).toFixed(0)}</td>
                </tr>`).join('');
        }

        function populateSelect() {
            const sel = document.getElementById('ingredientSelector');
            ingredients.forEach((ing, i) => sel.innerHTML += `<option value="${i}">${ing.name}</option>`);
        }

        function addIngredient() {
            const idx = document.getElementById('ingredientSelector').value;
            if(idx === "") return;
            formula.push({...ingredients[idx], pct: 1.0}); 
            renderFormula();
            recalc();
        }

        function renderFormula() {
            const tbody = document.getElementById('formulaBody');
            let html = `<tr class="bg-yiyu-secondary/10"><td class="p-3 font-medium text-yiyu-base flex items-center gap-2"><i class="fas fa-tint text-yiyu-secondary"></i> WATER</td><td class="p-3 text-right text-gray-600" id="waterPct">100.0</td><td class="p-3 text-right text-gray-400">-</td><td></td></tr>`;
            formula.forEach((item, i) => {
                html += `<tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                    <td class="p-3 text-gray-700 font-medium">${item.name}</td>
                    <td class="p-3 text-right"><input type="number" step="0.1" value="${item.pct}" onchange="formula[${i}].pct=parseFloat(this.value);recalc()" class="w-16 text-right border rounded p-1 bg-white outline-none focus:border-yiyu-primary"></td>
                    <td class="p-3 text-right text-xs text-gray-500 cost-cell" data-base="${(item.cost*item.pct/100).toFixed(1)}">0</td>
                    <td class="p-3 text-center"><button onclick="formula.splice(${i},1);renderFormula();recalc()" class="text-gray-300 hover:text-red-400 transition"><i class="fas fa-times"></i></button></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function recalc() {
            const rate = exchangeRates[currentCurrency];
            const fabIdx = document.getElementById('fabricSelect').value || 0;
            const fab = fabricsDB[fabIdx];

            let bulkCostKG = formula.reduce((s,i) => s+(i.cost*i.pct/100), 0);
            let fabCostSheet = fab.cost;
            let totalSheetCost = (bulkCostKG * 0.025) + fabCostSheet; 
            
            let channel = document.getElementById('salesChannel').value;
            let retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;
            let retailPriceTWD = retailPrice / rate.rate; 
            
            let marginRatio = 0.3; 
            if(channel === 'retail') marginRatio = 0.15; 
            if(channel === 'distributor') marginRatio = 0.20; 

            let targetCostTWD = retailPriceTWD * marginRatio;

            let totalPct = formula.reduce((s,i) => s+i.pct, 0);
            let water = Math.max(0, 100 - totalPct);
            document.getElementById('waterPct').innerText = water.toFixed(1);
            document.getElementById('totalPct').innerText = (totalPct + water).toFixed(1);
            document.getElementById('fabricDesc').innerText = fab.desc[currentLang];

            document.getElementById('finalCost').innerText = `${rate.symbol}${(totalSheetCost*rate.rate).toFixed(1)}`;
            document.getElementById('targetCostDisplay').innerText = `${rate.symbol}${(targetCostTWD*rate.rate).toFixed(1)}`;
            
            document.querySelectorAll('.cost-cell').forEach(c => {
                c.innerText = (parseFloat(c.dataset.base) * rate.rate).toFixed(1);
            });

            const warningBox = document.getElementById('costWarning');
            const diff = totalSheetCost - targetCostTWD;
            if(diff > 0) {
                warningBox.classList.remove('hidden');
                document.getElementById('overCostAmount').innerText = `+${rate.symbol}${(diff*rate.rate).toFixed(1)}`;
                document.getElementById('finalCost').classList.add('text-red-600');
            } else {
                warningBox.classList.add('hidden');
                document.getElementById('finalCost').classList.remove('text-red-600');
            }
            updateRadar();
        }

        function updateRadar() {
            if (!radarChart) return;
            let scores = { moist:0, white:0, aging:0, repair:0, oil:0 };
            let fStats = fabricsDB[document.getElementById('fabricSelect').value || 0].stats;
            for(let k in scores) scores[k] += fStats[k];
            formula.forEach(i => { for(let k in scores) scores[k] += i.stats[k] * (i.pct>0?1:0); });
            radarChart.data.datasets[0].data = Object.values(scores);
            radarChart.update();
        }

        function updateSystemCurrency() {
            currentCurrency = document.getElementById('currency').value;
            document.getElementById('currencySymbol').innerText = exchangeRates[currentCurrency].symbol;
            recalc();
            renderMarketTable();
            updateMarketMap();
        }
        
        function updateChartsLang() {
            const t = translations[currentLang];
            if(radarChart) { radarChart.data.labels = t.radar_labels; radarChart.update(); }
            if(marketMapChart) {
                marketMapChart.options.scales.x.title.text = t.map_x;
                marketMapChart.options.scales.y.title.text = t.map_y;
                marketMapChart.update();
            }
        }

        function updateMarketMap() {
            if (!marketMapChart) return;
            const rate = exchangeRates[currentCurrency];
            const data = competitorsDB.map(c => ({
                x: c.price * rate.rate,
                y: c.volume,
                r: 8,
                label: c.b
            }));
            marketMapChart.data.datasets[0].data = data;
            updateChartsLang();
        }

        function initCharts() {
            radarChart = new Chart(document.getElementById('radarChart').getContext('2d'), {
                type: 'radar',
                data: { labels: ['保濕', '美白', '抗老', '修護', '控油'], datasets: [{ data: [0,0,0,0,0], backgroundColor: 'rgba(95, 141, 117, 0.2)', borderColor: '#5F8D75', borderWidth: 2, pointBackgroundColor: '#5F8D75' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 12, ticks: { display: false }, pointLabels: { font: { size: 12, weight: 'bold' }, color: '#5F8D75' } } }, plugins: { legend: { display: false } } }
            });

            marketMapChart = new Chart(document.getElementById('marketMapChart').getContext('2d'), {
                type: 'bubble',
                data: { datasets: [{ data: [{x:25,y:85,r:8},{x:28,y:95,r:8},{x:60,y:75,r:8},{x:120,y:40,r:8}], backgroundColor: 'rgba(95, 141, 117, 0.6)', borderColor: '#2D4A3E' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { title: { display: true, text: 'Price' } }, y: { title: { display: true, text: 'Volume' }, min: 0, max: 100 } } }
            });
        }

        // --- PDF EXPORT ---
        function exportToPDF() {
            const container = document.getElementById('pdf-container');
            const overlay = document.getElementById('loading-overlay');
            const t = translations[currentLang];
            const rate = exchangeRates[currentCurrency];
            const finalCost = document.getElementById('finalCost').innerText;
            const targetCost = document.getElementById('targetCostDisplay').innerText;
            const fabIdx = document.getElementById('fabricSelect').value || 0;
            const fab = fabricsDB[fabIdx];
            const channelSelect = document.getElementById('salesChannel');
            const channelText = channelSelect.options[channelSelect.selectedIndex].text;

            // Show UI
            overlay.style.display = 'flex';
            // container.classList.add('show-pdf'); // Use visibility: visible in css

            // Capture Radar
            const radarCanvas = document.getElementById('radarChart');
            const radarImgData = radarCanvas.toDataURL("image/png");

            // Build Formula Rows
            let formulaRows = formula.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td style="text-align:right">${item.pct}%</td>
                    <td style="text-align:right">${(item.cost*item.pct/100 * rate.rate).toFixed(1)}</td>
                </tr>`).join('');
            // Add Water
            const waterPct = document.getElementById('waterPct').innerText;
            formulaRows = `<tr><td>WATER</td><td style="text-align:right">${waterPct}%</td><td style="text-align:right">-</td></tr>` + formulaRows;

            // Build Assets HTML
            const assetsList = productsDB.map(p => `
                <div class="pdf-product">
                    <img src="${p.img}" alt="Product" onerror="this.onerror=null;this.src='https://placehold.co/100x100/eee/999?text=IMG'">
                    <div>
                        <div style="font-weight:bold; color: #2D4A3E;">${p.name[currentLang]}</div>
                        <div style="font-size: 10px; color: #666; margin: 4px 0;">${p.desc[currentLang]}</div>
                        <div style="font-size: 10px; color: #5F8D75;">Key: ${p.key}</div>
                    </div>
                </div>
            `).join('');

            // Build Claims
            const claimsHtml = activeClaims.length > 0 
                ? activeClaims.map(c => `<span style="display:inline-block; background:#5F8D75; color:white; padding:2px 8px; border-radius:10px; font-size:10px; margin-right:4px;">${t.claims[c]}</span>`).join('')
                : `<span style="color:#999; font-size:10px;">--</span>`;

            // PDF HTML Template
            const htmlContent = `
                <div class="pdf-page">
                    <div class="pdf-header">
                        <img src="logo.png" style="height:40px;" onerror="this.src='https://placehold.co/150x50/2D4A3E/FFFFFF?text=AMS+BioteQ'">
                        <div style="font-size: 12px; color: #666;">${t.print_page_title1}</div>
                    </div>
                    
                    <div class="pdf-section-title">${t.print_section1}</div>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                        <div style="width: 48%; border:1px solid #eee; padding:10px; border-radius:8px;">
                            <div style="font-weight:bold; font-size:12px; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">${t.sect_sales}</div>
                            <div style="font-size:11px; color:#444;">Channel: ${channelText}</div>
                            <div style="font-size:11px; color:#444;">Retail: ${document.getElementById('retailPrice').value} ${rate.unit}</div>
                            <div style="font-size:11px; color:#444;">Target Cost: ${targetCost}</div>
                        </div>
                        <div style="width: 48%; border:1px solid #eee; padding:10px; border-radius:8px;">
                            <div style="font-weight:bold; font-size:12px; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">${t.sect_claims}</div>
                            <div>${claimsHtml}</div>
                            <div style="margin-top:10px; font-size:11px; color:#2D4A3E;"><strong>Fabric:</strong> ${fab.name[currentLang]}</div>
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between;">
                        <div style="width: 55%;">
                            <div class="pdf-section-title" style="font-size:12px; margin-bottom:5px;">${t.sect_structure}</div>
                            <table class="pdf-table">
                                <thead><tr><th>Ingredient</th><th style="text-align:right">%</th><th style="text-align:right">Cost</th></tr></thead>
                                <tbody>${formulaRows}</tbody>
                            </table>
                            <div style="background:#f9f9f9; padding:10px; border-left:4px solid #5F8D75;">
                                <strong>Actual Cost: ${finalCost} / sheet</strong>
                            </div>
                        </div>
                        <div style="width: 40%; text-align:center;">
                            <div style="margin-bottom:5px; font-weight:bold; font-size:12px;">Efficacy Radar</div>
                            <img src="${radarImgData}" style="width:100%;">
                            <div style="margin-top:15px; text-align:left; background:#E8F3EB; padding:10px; border-radius:4px;">
                                <div style="font-weight:bold; font-size:10px; color:#2D4A3E;">AI Insight</div>
                                <div style="font-size:10px; color:#444;">${document.getElementById('aiSuggestion').innerText}</div>
                            </div>
                        </div>
                    </div>

                    <div class="pdf-footer">
                        AMS BioteQ | Innovation for Life | Email: contact@amsbioteq.com | Date: ${new Date().toLocaleDateString()}
                    </div>
                </div>

                <div class="pdf-page">
                    <div class="pdf-header">
                        <img src="logo.png" style="height:40px;" onerror="this.src='https://placehold.co/150x50/2D4A3E/FFFFFF?text=AMS+BioteQ'">
                        <div style="font-size: 12px; color: #666;">${t.print_page_title2}</div>
                    </div>
                    
                    <div class="pdf-section-title">${t.print_section2}</div>
                    <div>${assetsList}</div>

                    <div class="pdf-footer">
                        AMS BioteQ | Innovation for Life | Email: contact@amsbioteq.com | Date: ${new Date().toLocaleDateString()}
                    </div>
                </div>
            `;

            container.innerHTML = htmlContent;

            const opt = {
                margin:       0,
                filename:     'AMS_BioteQ_Report.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            setTimeout(() => {
                html2pdf().set(opt).from(container).save().then(() => {
                    container.innerHTML = '';
                    overlay.style.display = 'none';
                }).catch(err => {
                    console.error(err);
                    alert("PDF Generation Error: " + err.message);
                    overlay.style.display = 'none';
                });
            }, 1000);
        }
    </script>
</body>
</html>
