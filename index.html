<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Mask Engine (AMS BioteQ Co., Ltd.)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥ html2pdf.js ç”¨æ–¼ç”Ÿæˆ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        yiyu: {
                            base: '#2D4A3E',
                            primary: '#5F8D75',
                            secondary: '#A3B18A',
                            accent: '#D0E1D4',
                            bg: '#F9F8F6',
                            text: '#2C3333',
                            danger: '#EF4444'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F9F8F6; color: #2C3333; }
        .sidebar { background: linear-gradient(180deg, #2D4A3E 0%, #1B352C 100%); color: white; }
        .logo-section { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .subtitle { font-family: 'Georgia', serif; font-style: italic; font-size: 0.7rem; color: #A3B18A; letter-spacing: 0.8px; margin-top: 6px; opacity: 0.9; }
        .nav-item { padding: 16px 20px; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; color: #A3B18A; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(95, 141, 117, 0.15); border-left-color: #5F8D75; color: #fff; font-weight: 500; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(45, 74, 62, 0.04); padding: 24px; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid rgba(163, 177, 138, 0.15); }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(45, 74, 62, 0.08); border-color: rgba(95, 141, 117, 0.3); }
        .tag-select { cursor: pointer; border: 1px solid #A3B18A; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; color: #5F8D75; transition: 0.2s; background: white; }
        .tag-select:hover { background: #F0F5F2; border-color: #5F8D75; }
        .tag-select.selected { background: #5F8D75; color: white; border-color: #5F8D75; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .animate-fade-in { animation: fadeIn 0.6s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .pdf-btn { background: linear-gradient(135deg, #2D4A3E 0%, #5F8D75 100%); color: white; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; border: none; display: flex; align-items: center; gap: 8px; }
        .pdf-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(45, 74, 62, 0.3); }
        
        /* ==================== PRINT STYLES ==================== */
        @media print {
            body, html { background: white !important; margin: 0; padding: 0; }
            .sidebar, .pdf-btn, .no-print, [onclick], button, select, input, .sticky { display: none !important; }
            #mainContent { margin: 0 !important; padding: 0 !important; width: 100% !important; overflow: visible !important; }
            #tab-lab, #tab-market, #tab-products { display: none !important; }
            #printReport { display: block !important; }
            
            @page { size: A4 portrait; margin: 0; }
            
            .print-page { width: 210mm; min-height: 297mm; padding: 15mm; margin: 0 auto; background: white; page-break-after: always; box-sizing: border-box; position: relative; }
            .print-page:last-child { page-break-after: auto; }
            
            .print-header { background: #2D4A3E !important; color: white !important; padding: 15px 20px; margin: -15mm -15mm 20px -15mm; width: calc(100% + 30mm); display: flex; justify-content: space-between; align-items: center; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .print-header h1 { font-size: 18px; font-weight: bold; margin: 0; }
            .print-header .tagline { font-size: 10px; color: #A3B18A; font-style: italic; margin-top: 4px; }
            .print-header .page-title { font-size: 12px; color: #D0E1D4; }
            
            .print-footer { position: absolute; bottom: 10mm; left: 15mm; right: 15mm; border-top: 1px solid #A3B18A; padding-top: 10px; font-size: 10px; color: #666; display: flex; justify-content: space-between; }
            
            .print-card { background: #fafafa !important; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .print-card h3 { font-size: 12px; font-weight: bold; color: #2D4A3E; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0; }
            
            .print-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
            .print-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            
            .print-table { width: 100%; border-collapse: collapse; font-size: 11px; }
            .print-table th { background: #2D4A3E !important; color: white !important; padding: 10px; text-align: left; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .print-table td { padding: 10px; border-bottom: 1px solid #e0e0e0; }
            .print-table tr:nth-child(even) { background: #f5f5f5 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            .print-product { background: white !important; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; border-top: 3px solid #5F8D75; display: flex; flex-direction: column; }
            .print-product img { width: 100%; height: 120px; object-fit: cover; margin-bottom: 10px; border-radius: 4px; }
            .print-product h4 { font-size: 13px; font-weight: bold; color: #2D4A3E; margin-bottom: 8px; }
            .print-product p { font-size: 10px; color: #666; margin-bottom: 8px; line-height: 1.5; }
            .print-product .key { font-size: 10px; color: #5F8D75; font-weight: 600; margin-top: auto; }
            
            .print-highlight { background: #E8F3EB !important; border: 1px solid #CDE5D6; border-radius: 8px; padding: 15px; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            .print-tag { display: inline-block; background: #5F8D75 !important; color: white !important; padding: 4px 12px; border-radius: 15px; font-size: 10px; margin: 3px; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            .print-cost { font-size: 28px; font-weight: bold; color: #5F8D75; }
            .print-section-title { font-size: 16px; font-weight: bold; color: #2D4A3E; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #5F8D75; }
        }
        
        #printReport { display: none; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm md:text-base">

    <!-- Sidebar -->
    <div class="sidebar w-20 md:w-64 flex-shrink-0 flex flex-col shadow-2xl z-20">
        <div class="logo-section flex flex-col">
            <img src="logo.png" alt="AMS BioteQ" class="w-32 md:w-40 mb-2 object-contain h-auto" id="mainLogo" onerror="this.onerror=null;this.src='https://placehold.co/200x60/2D4A3E/FFFFFF?text=AMS+BioteQ'">
            <div class="subtitle">the art of micro-ecology balance</div>
        </div>
        <nav class="mt-6 flex-1 px-2 space-y-2">
            <div class="nav-item active rounded" onclick="switchTab('lab', this)">
                <div class="flex items-center gap-3">
                    <i class="fas fa-flask text-lg w-6 text-center"></i>
                    <span class="hidden md:block" data-i18n="nav_lab">é…æ–¹é–‹ç™¼å¯¦é©—å®¤</span>
                </div>
            </div>
            <div class="nav-item rounded" onclick="switchTab('market', this)">
                <div class="flex items-center gap-3">
                    <i class="fas fa-chart-line text-lg w-6 text-center"></i>
                    <span class="hidden md:block" data-i18n="nav_market">å¸‚å ´è¶¨å‹¢æ´å¯Ÿ</span>
                </div>
            </div>
            <div class="nav-item rounded" onclick="switchTab('products', this)">
                <div class="flex items-center gap-3">
                    <i class="fas fa-database text-lg w-6 text-center"></i>
                    <span class="hidden md:block" data-i18n="nav_assets">ä¼æ¥­é…æ–¹è³‡ç”¢</span>
                </div>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto bg-yiyu-bg p-4 md:p-8 relative" id="mainContent">
        
        <!-- Top Bar -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 sticky top-0 bg-yiyu-bg/95 backdrop-blur z-10 py-3 border-b border-gray-200/50">
            <div>
                <h1 id="pageTitle" class="text-2xl font-bold text-yiyu-base tracking-tight" data-i18n="title_lab">é…æ–¹é–‹ç™¼å¯¦é©—å®¤</h1>
                <p id="pageDesc" class="text-gray-500 text-xs md:text-sm mt-1" data-i18n="desc_lab">å¾®ç”Ÿæ…‹å¹³è¡¡å°å‘çš„ AI é¢è†œä¼åŠƒå¼•æ“</p>
            </div>
            <div class="flex gap-3 items-center flex-wrap justify-end">
                <button class="pdf-btn" onclick="printReport()">
                    <i class="fas fa-file-pdf"></i>
                    <span data-i18n="btn_export_pdf">åŒ¯å‡º PDF</span>
                </button>
                
                <div class="flex gap-3 bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex items-center gap-2 px-3 border-r border-gray-200">
                        <i class="fas fa-globe text-yiyu-primary"></i>
                        <select id="langSelect" class="bg-transparent font-bold text-gray-600 outline-none cursor-pointer text-sm" onchange="changeLanguage(this.value)">
                            <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                            <option value="en-US">English</option>
                            <option value="ja-JP">æ—¥æœ¬èª</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 px-3">
                        <i class="fas fa-coins text-yellow-600"></i>
                        <select id="currency" class="bg-transparent font-bold text-gray-600 outline-none cursor-pointer text-sm" onchange="updateSystemCurrency()">
                            <option value="TWD">TWD ($)</option>
                            <option value="JPY">JPY (Â¥)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- LAB TAB -->
        <div id="tab-lab" class="animate-fade-in space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card border-l-4 border-yiyu-primary">
                        <h3 class="font-bold text-yiyu-base mb-4 text-xs uppercase tracking-widest border-b pb-2 border-gray-100" data-i18n="sect_sales">0. éŠ·å”®æ¸ é“èˆ‡å®šåƒ¹</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1" data-i18n="lbl_channel">é¸æ“‡éŠ·å”®æ¸ é“</label>
                                <select id="salesChannel" class="w-full p-2 bg-gray-50 border border-gray-200 rounded text-sm" onchange="recalc()">
                                    <option value="own" data-i18n="opt_own">è‡ªæœ‰å“ç‰Œå®˜ç¶² (DTC)</option>
                                    <option value="retail" data-i18n="opt_retail">å¯¦é«”é€šè·¯/ä¸Šæ¶ (Retail)</option>
                                    <option value="distributor" data-i18n="opt_dist">ç¶“éŠ·ä»£ç† (Distributor)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1" data-i18n="lbl_price">å–®ç‰‡é è¨ˆå”®åƒ¹ (æœ«ç«¯)</label>
                                <div class="flex items-center">
                                    <span class="bg-gray-100 p-2 rounded-l text-gray-500 text-sm" id="currencySymbol">NT$</span>
                                    <input type="number" id="retailPrice" value="50" class="w-full p-2 border border-gray-200 rounded-r text-sm text-right" onchange="recalc()">
                                </div>
                            </div>
                            <div class="bg-gray-100 p-3 rounded text-xs text-gray-600">
                                <span data-i18n="lbl_target_cost">ç›®æ¨™æˆæœ¬ä¸Šé™ (COGS):</span> <br>
                                <span id="targetCostDisplay" class="text-lg font-bold text-yiyu-primary">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="font-bold text-yiyu-base mb-4 text-xs uppercase tracking-widest border-b pb-2 border-gray-100" data-i18n="sect_claims">1. æ ¸å¿ƒè¨´æ±‚ Claims</h3>
                        <div class="flex flex-wrap gap-2" id="claimsContainer"></div>
                    </div>

                    <div class="card">
                        <h3 class="font-bold text-yiyu-base mb-4 text-xs uppercase tracking-widest border-b pb-2 border-gray-100" data-i18n="sect_fabric">2. è†œå¸ƒè¼‰é«” Fabric</h3>
                        <select id="fabricSelect" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm mb-2" onchange="recalc()"></select>
                        <p id="fabricDesc" class="text-xs text-gray-500 italic mt-1 pl-1">...</p>
                    </div>

                    <div class="card bg-gradient-to-br from-[#E8F3EB] to-[#F5F9F6] border border-[#CDE5D6] shadow-none">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 rounded-full bg-yiyu-primary flex items-center justify-center text-white text-xs"><i class="fas fa-robot"></i></div>
                            <h3 class="font-bold text-yiyu-base text-sm" data-i18n="sect_ai">AI æ™ºå›Š</h3>
                        </div>
                        <div id="aiSuggestion" class="text-xs text-gray-700 leading-relaxed min-h-[40px] font-medium" data-i18n="ai_waiting">ç­‰å¾…è¼¸å…¥æ ¸å¿ƒè¨´æ±‚...</div>
                    </div>
                </div>

                <div class="lg:col-span-5">
                    <div class="card h-full flex flex-col border-t-4 border-t-yiyu-base">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-yiyu-base" data-i18n="sect_structure">é…æ–¹æ¶æ§‹</h3>
                            <span class="text-xs font-mono bg-yiyu-secondary/20 text-yiyu-base px-2 py-1 rounded font-bold">Total: <span id="totalPct">0</span>%</span>
                        </div>
                        
                        <div class="flex gap-2 mb-4">
                            <select id="ingredientSelector" class="flex-1 p-2 bg-gray-50 border border-gray-200 rounded text-sm">
                                <option value="" data-i18n="opt_add_ing">+ é¸æ“‡æ´»æ€§æˆåˆ†...</option>
                            </select>
                            <button onclick="addIngredient()" class="bg-yiyu-primary hover:bg-yiyu-base text-white w-10 h-10 rounded shadow-md"><i class="fas fa-plus"></i></button>
                        </div>

                        <div class="flex-1 overflow-y-auto bg-gray-50 rounded border border-gray-100 p-1">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-gray-400 border-b border-gray-200 bg-gray-100/50 sticky top-0">
                                    <tr><th class="p-2 text-left pl-3">INCI Name</th><th class="p-2 text-right w-16">%</th><th class="p-2 text-right w-20" data-i18n="col_cost">Cost</th><th class="p-2 w-8"></th></tr>
                                </thead>
                                <tbody id="formulaBody">
                                    <tr class="bg-blue-50/30">
                                        <td class="p-3 font-medium text-yiyu-base"><i class="fas fa-tint text-blue-300 mr-2"></i>WATER</td>
                                        <td class="p-3 text-right text-gray-600" id="waterPct">100.0</td>
                                        <td class="p-3 text-right text-gray-400">-</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-100 bg-gray-50/50 p-3 rounded-lg">
                            <div class="flex justify-between items-end mb-2">
                                <div class="text-xs text-gray-500 font-medium uppercase" data-i18n="lbl_actual_cost">å¯¦éš›æˆæœ¬<br>(Per Sheet)</div>
                                <div class="text-3xl font-bold text-yiyu-primary" id="finalCost">NT$0</div>
                            </div>
                            <div id="costWarning" class="hidden bg-red-50 border border-red-200 text-red-600 p-2 rounded text-xs flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span><span data-i18n="msg_warning">è­¦å‘Šï¼šè¶…å‡ºç›®æ¨™æˆæœ¬</span> <span id="overCostAmount" class="font-bold"></span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4">
                    <div class="card h-full flex flex-col">
                        <h3 class="font-bold text-yiyu-base mb-2 text-xs uppercase tracking-widest" data-i18n="sect_efficacy">3. æ•ˆèƒ½é æ¸¬ Efficacy</h3>
                        <div class="chart-container flex-1">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MARKET TAB -->
        <div id="tab-market" class="hidden animate-fade-in space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card lg:col-span-2">
                    <h3 class="font-bold text-yiyu-base mb-4" data-i18n="sect_pos_map">å¸‚å ´å®šä½è±¡é™åœ–</h3>
                    <div class="chart-container h-80"><canvas id="marketMapChart"></canvas></div>
                </div>
                <div class="card">
                    <h3 class="font-bold text-yiyu-base mb-4" data-i18n="sect_sentiment">AI è¼¿æƒ…æ´å¯Ÿ</h3>
                    <div class="space-y-4">
                        <div class="bg-white p-3 rounded-lg shadow-sm border">
                            <div class="text-xs text-gray-400 mb-2 font-bold" data-i18n="lbl_keywords">æ¶ˆè²»è€…ç†±è­°é—œéµå­—</div>
                            <div class="flex flex-wrap gap-2" id="marketKeywords"><span class="text-xs text-gray-400" data-i18n="ai_waiting">è«‹å…ˆé¸æ“‡æ ¸å¿ƒè¨´æ±‚...</span></div>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm border">
                            <div class="text-xs text-gray-400 mb-2 font-bold" data-i18n="lbl_gap">å¸‚å ´ç¼ºå£</div>
                            <p class="text-xs text-gray-600" id="marketGap" data-i18n="msg_waiting_param">ç³»çµ±æ­£ç­‰å¾…é…æ–¹åƒæ•¸è¼¸å…¥...</p>
                        </div>
                        <div class="bg-yiyu-primary/5 p-3 rounded-lg border border-yiyu-primary/20">
                            <div class="text-xs text-yiyu-primary font-bold mb-1" data-i18n="lbl_strategy">å»ºè­°å®šåƒ¹ç­–ç•¥</div>
                            <p class="text-xs text-gray-700" id="marketStrategy">--</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- [ä¿®å¾©] è£œå›ç«¶å“æ¯”è¼ƒè¡¨ -->
            <div class="card">
                <h3 class="font-bold text-yiyu-base mb-4 flex items-center gap-2">
                    <i class="fas fa-list-ul text-yiyu-primary"></i> 
                    <span data-i18n="sect_competitors">ç«¶å“è©³ç´°è¦æ ¼å°æ¯”</span>
                </h3>
                <div class="overflow-x-auto border border-gray-100 rounded-lg">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <tr>
                                <th class="p-3 pl-4">Brand</th>
                                <th class="p-3" data-i18n="col_claim">Core Claim</th>
                                <th class="p-3" data-i18n="col_ingredients">Key Ingredients</th>
                                <th class="p-3" data-i18n="col_feedback">User Feedback (AI Summary)</th>
                                <th class="p-3 text-right pr-4" data-i18n="col_retail_price">Est. Retail Price</th>
                            </tr>
                        </thead>
                        <tbody id="competitorTable" class="divide-y divide-gray-100 bg-white">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="tab-products" class="hidden animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productGrid"></div>
        </div>

        <!-- ==================== PRINT REPORT ==================== -->
        <div id="printReport">
            <div class="print-page">
                <div class="print-header">
                    <div>
                        <h1>AMS BioteQ</h1>
                        <div class="tagline">the art of micro-ecology balance</div>
                    </div>
                    <div class="page-title" id="printPageTitle1">é…æ–¹é–‹ç™¼å¯¦é©—å®¤å ±å‘Š</div>
                </div>
                
                <div class="print-section-title" id="printSectionTitle1">é…æ–¹ä¼åŠƒæ¦‚è¦</div>
                
                <div class="print-grid-2" style="margin-bottom: 20px;">
                    <div class="print-card">
                        <h3>éŠ·å”®æ¸ é“èˆ‡å®šåƒ¹</h3>
                        <p style="font-size: 11px; color: #444; margin: 5px 0;"><strong>æ¸ é“ï¼š</strong><span id="printChannel">--</span></p>
                        <p style="font-size: 11px; color: #444; margin: 5px 0;"><strong>å»ºè­°å”®åƒ¹ï¼š</strong><span id="printRetailPrice">--</span></p>
                        <p style="font-size: 11px; color: #444; margin: 5px 0;"><strong>ç›®æ¨™æˆæœ¬ï¼š</strong><span id="printTargetCost">--</span></p>
                    </div>
                    <div class="print-card">
                        <h3>æ ¸å¿ƒè¨´æ±‚ Claims</h3>
                        <div id="printClaims" style="margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="print-card" style="margin-bottom: 20px;">
                    <h3>è†œå¸ƒè¼‰é«” Fabric</h3>
                    <p style="font-size: 12px; color: #2D4A3E; font-weight: 600;" id="printFabric">--</p>
                    <p style="font-size: 10px; color: #888; font-style: italic;" id="printFabricDesc">--</p>
                </div>
                
                <div class="print-card" style="margin-bottom: 20px;">
                    <h3>é…æ–¹æ¶æ§‹ Formula Structure</h3>
                    <table class="print-table">
                        <thead><tr><th>INCI Name</th><th style="text-align: right; width: 80px;">%</th><th style="text-align: right; width: 100px;">Cost</th></tr></thead>
                        <tbody id="printFormulaBody"></tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: right; padding-top: 10px; border-top: 2px solid #5F8D75;">
                        <span style="font-size: 11px; color: #666;">å¯¦éš›æˆæœ¬ (Per Sheet)ï¼š</span>
                        <span class="print-cost" id="printFinalCost">--</span>
                    </div>
                </div>
                
                <div class="print-highlight">
                    <div style="font-size: 11px; font-weight: bold; color: #2D4A3E; margin-bottom: 8px;">ğŸ¤– AI æ™ºå›Šå»ºè­°</div>
                    <p style="font-size: 11px; color: #444; line-height: 1.6;" id="printAiSuggestion">--</p>
                </div>
                
                <div class="print-footer">
                    <span>felixtsai@amsbioteq.com</span>
                    <span id="printDate1">--</span>
                </div>
            </div>
            
            <div class="print-page">
                <div class="print-header">
                    <div>
                        <h1>AMS BioteQ</h1>
                        <div class="tagline">the art of micro-ecology balance</div>
                    </div>
                    <div class="page-title" id="printPageTitle2">ä¼æ¥­é…æ–¹è³‡ç”¢</div>
                </div>
                
                <div class="print-section-title" id="printSectionTitle2">å·²ä¸Šå¸‚ç”¢å“ç·š</div>
                
                <div class="print-grid-3" id="printProductGrid"></div>
                
                <div class="print-footer">
                    <span>felixtsai@amsbioteq.com</span>
                    <span id="printDate2">--</span>
                </div>
            </div>
        </div>
    </div> 

    <script>
        const translations = {
            'zh-TW': { 
                claims: { oil: "æ§æ²¹å¹³è¡¡", moist: "é«˜æ•ˆä¿æ¿•", white: "é€äº®ç…¥ç™½", aging: "ç·Šç·»æ’«ç´‹", repair: "å±éšœä¿®è­·" }, 
                radar_labels: ['ä¿æ¿•', 'ç¾ç™½', 'æŠ—è€', 'ä¿®è­·', 'æ§æ²¹'], 
                print_page_title1: "é…æ–¹é–‹ç™¼å¯¦é©—å®¤å ±å‘Š", 
                print_page_title2: "ä¼æ¥­é…æ–¹è³‡ç”¢", 
                print_section1: "é…æ–¹ä¼åŠƒæ¦‚è¦", 
                print_section2: "å·²ä¸Šå¸‚ç”¢å“ç·š", 
                ai_waiting: "ç­‰å¾…è¼¸å…¥æ ¸å¿ƒè¨´æ±‚...", 
                ai_prefix: "AI æ¨è–¦æˆåˆ†: ", 
                channel: { own: "è‡ªæœ‰å“ç‰Œå®˜ç¶² (DTC)", retail: "å¯¦é«”é€šè·¯/ä¸Šæ¶ (Retail)", distributor: "ç¶“éŠ·ä»£ç† (Distributor)" },
                nav_lab: "é…æ–¹é–‹ç™¼å¯¦é©—å®¤",
                nav_market: "å¸‚å ´è¶¨å‹¢æ´å¯Ÿ",
                nav_assets: "ä¼æ¥­é…æ–¹è³‡ç”¢",
                title_lab: "é…æ–¹é–‹ç™¼å¯¦é©—å®¤",
                desc_lab: "å¾®ç”Ÿæ…‹å¹³è¡¡å°å‘çš„ AI é¢è†œä¼åŠƒå¼•æ“",
                btn_export_pdf: "åŒ¯å‡º PDF",
                sect_sales: "0. éŠ·å”®æ¸ é“èˆ‡å®šåƒ¹",
                lbl_channel: "é¸æ“‡éŠ·å”®æ¸ é“",
                opt_own: "è‡ªæœ‰å“ç‰Œå®˜ç¶² (DTC)",
                opt_retail: "å¯¦é«”é€šè·¯/ä¸Šæ¶ (Retail)",
                opt_dist: "ç¶“éŠ·ä»£ç† (Distributor)",
                lbl_price: "å–®ç‰‡é è¨ˆå”®åƒ¹ (æœ«ç«¯)",
                lbl_target_cost: "ç›®æ¨™æˆæœ¬ä¸Šé™ (COGS):",
                sect_claims: "1. æ ¸å¿ƒè¨´æ±‚ Claims",
                sect_fabric: "2. è†œå¸ƒè¼‰é«” Fabric",
                sect_ai: "AI æ™ºå›Š",
                sect_structure: "é…æ–¹æ¶æ§‹",
                opt_add_ing: "+ é¸æ“‡æ´»æ€§æˆåˆ†...",
                col_cost: "æˆæœ¬",
                lbl_actual_cost: "å¯¦éš›æˆæœ¬ (Per Sheet)",
                msg_warning: "è­¦å‘Šï¼šè¶…å‡ºç›®æ¨™æˆæœ¬",
                sect_efficacy: "3. æ•ˆèƒ½é æ¸¬ Efficacy",
                sect_pos_map: "å¸‚å ´å®šä½è±¡é™åœ– (Positioning Map)",
                sect_sentiment: "AI è¼¿æƒ…æ´å¯Ÿ (Sentiment)",
                lbl_keywords: "æ¶ˆè²»è€…ç†±è­°é—œéµå­—",
                lbl_gap: "å¸‚å ´ç¼ºå£ (GAP Analysis)",
                msg_waiting_param: "ç³»çµ±æ­£ç­‰å¾…é…æ–¹åƒæ•¸è¼¸å…¥...",
                lbl_strategy: "å»ºè­°å®šåƒ¹ç­–ç•¥",
                sect_competitors: "ç«¶å“è©³ç´°è¦æ ¼å°æ¯”",
                col_claim: "ä¸»è¨´æ±‚",
                col_ingredients: "é—œéµæˆåˆ†",
                col_feedback: "ç”¨æˆ¶åé¥‹ (AIæ‘˜è¦)",
                col_retail_price: "é ä¼°å”®åƒ¹",
                map_x: "åƒ¹æ ¼",
                map_y: "å¸‚å ´è²é‡"
            },
            'en-US': { 
                claims: { oil: "Oil Control", moist: "Hydration", white: "Brightening", aging: "Anti-Aging", repair: "Repairing" }, 
                radar_labels: ['Moist', 'White', 'Anti-Aging', 'Repair', 'Oil Ctrl'], 
                print_page_title1: "Formula Lab Report", 
                print_page_title2: "Product Assets", 
                print_section1: "Formula Planning Overview", 
                print_section2: "Launched Product Line", 
                ai_waiting: "Waiting for input...", 
                ai_prefix: "AI Suggests: ", 
                channel: { own: "DTC (Official Site)", retail: "Retail Stores", distributor: "Distributors" },
                nav_lab: "Formula Lab",
                nav_market: "Market Insights",
                nav_assets: "Enterprise Assets",
                title_lab: "Formula Development Lab",
                desc_lab: "Micro-ecology Balance AI Engine",
                btn_export_pdf: "Export PDF",
                sect_sales: "0. Sales Channel & Pricing",
                lbl_channel: "Select Sales Channel",
                opt_own: "DTC (Official Site)",
                opt_retail: "Retail Stores",
                opt_dist: "Distributors",
                lbl_price: "Est. Retail Price (Unit)",
                lbl_target_cost: "Target COGS Limit:",
                sect_claims: "1. Core Claims",
                sect_fabric: "2. Fabric Carrier",
                sect_ai: "AI Insights",
                sect_structure: "Formula Structure",
                opt_add_ing: "+ Add Active Ingredient...",
                col_cost: "Cost",
                lbl_actual_cost: "Actual Cost (Per Sheet)",
                msg_warning: "Warning: Exceeds Target Cost",
                sect_efficacy: "3. Efficacy Prediction",
                sect_pos_map: "Market Positioning Map",
                sect_sentiment: "AI Sentiment Analysis",
                lbl_keywords: "Consumer Keywords",
                lbl_gap: "Market Gap Analysis",
                msg_waiting_param: "Waiting for formula parameters...",
                lbl_strategy: "Pricing Strategy",
                sect_competitors: "Competitor Specs Comparison",
                col_claim: "Core Claim",
                col_ingredients: "Key Ingredients",
                col_feedback: "User Feedback (AI)",
                col_retail_price: "Est. Price",
                map_x: "Price",
                map_y: "Market Volume"
            },
            'ja-JP': { 
                claims: { oil: "çš®è„‚ã‚±ã‚¢", moist: "é«˜ä¿æ¹¿", white: "ç¾ç™½ãƒ»é€æ˜æ„Ÿ", aging: "ã‚¨ã‚¤ã‚¸ãƒ³ã‚°ã‚±ã‚¢", repair: "ãƒãƒªã‚¢ä¿®å¾©" }, 
                radar_labels: ['ä¿æ¹¿', 'ç¾ç™½', 'ã‚¨ã‚¤ã‚¸ãƒ³ã‚°', 'ä¿®å¾©', 'çš®è„‚'], 
                print_page_title1: "å‡¦æ–¹ãƒ©ãƒœãƒ¬ãƒãƒ¼ãƒˆ", 
                print_page_title2: "è£½å“è³‡ç”£", 
                print_section1: "å‡¦æ–¹ä¼ç”»æ¦‚è¦", 
                print_section2: "ç™ºå£²æ¸ˆã¿è£½å“ãƒ©ã‚¤ãƒ³", 
                ai_waiting: "è¨´æ±‚ã‚’é¸æŠã—ã¦ãã ã•ã„...", 
                ai_prefix: "AI æ¨å¥¨æˆåˆ†: ", 
                channel: { own: "è‡ªç¤¾EC (DTC)", retail: "å®Ÿåº—èˆ— (Retail)", distributor: "ä»£ç†åº— (Distributor)" },
                nav_lab: "å‡¦æ–¹é–‹ç™ºãƒ©ãƒœ",
                nav_market: "å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ",
                nav_assets: "è£½å“è³‡ç”£",
                title_lab: "å‡¦æ–¹é–‹ç™ºãƒ©ãƒœ",
                desc_lab: "ç¾è‚ŒèŒãƒãƒ©ãƒ³ã‚¹æŒ‡å‘ AI ä¼ç”»ã‚¨ãƒ³ã‚¸ãƒ³",
                btn_export_pdf: "PDF ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
                sect_sales: "0. è²©å£²ãƒãƒ£ãƒãƒ«ã¨ä¾¡æ ¼è¨­å®š",
                lbl_channel: "è²©å£²ãƒãƒ£ãƒãƒ«é¸æŠ",
                opt_own: "è‡ªç¤¾EC (DTC)",
                opt_retail: "å®Ÿåº—èˆ— (Retail)",
                opt_dist: "ä»£ç†åº— (Distributor)",
                lbl_price: "äºˆæƒ³å°å£²ä¾¡æ ¼ (å˜ä¾¡)",
                lbl_target_cost: "ç›®æ¨™åŸä¾¡ä¸Šé™ (COGS):",
                sect_claims: "1. ã‚³ã‚¢è¨´æ±‚ Claims",
                sect_fabric: "2. ã‚·ãƒ¼ãƒˆç´ æ Fabric",
                sect_ai: "AI ã‚¤ãƒ³ã‚µã‚¤ãƒˆ",
                sect_structure: "å‡¦æ–¹æ§‹æˆ",
                opt_add_ing: "+ æœ‰åŠ¹æˆåˆ†ã‚’è¿½åŠ ...",
                col_cost: "ã‚³ã‚¹ãƒˆ",
                lbl_actual_cost: "å®ŸåŸä¾¡ (Per Sheet)",
                msg_warning: "è­¦å‘Šï¼šç›®æ¨™ã‚³ã‚¹ãƒˆè¶…é",
                sect_efficacy: "3. åŠ¹èƒ½äºˆæ¸¬",
                sect_pos_map: "å¸‚å ´ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ãƒãƒƒãƒ—",
                sect_sentiment: "AI å£ã‚³ãƒŸåˆ†æ",
                lbl_keywords: "æ³¨ç›®ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰",
                lbl_gap: "å¸‚å ´ã‚®ãƒ£ãƒƒãƒ—åˆ†æ",
                msg_waiting_param: "åˆ†æãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å…¥åŠ›å¾…ã¡...",
                lbl_strategy: "æ¨å¥¨ä¾¡æ ¼æˆ¦ç•¥",
                sect_competitors: "ç«¶åˆè£½å“ã‚¹ãƒšãƒƒã‚¯æ¯”è¼ƒ",
                col_claim: "è¨´æ±‚",
                col_ingredients: "ã‚­ãƒ¼æˆåˆ†",
                col_feedback: "ãƒ¦ãƒ¼ã‚¶ãƒ¼è©•ä¾¡ (AIè¦ç´„)",
                col_retail_price: "äºˆæƒ³ä¾¡æ ¼",
                map_x: "ä¾¡æ ¼",
                map_y: "å¸‚å ´ãƒœãƒªãƒ¥ãƒ¼ãƒ "
            }
        };

        let currentLang = 'zh-TW';
        const exchangeRates = { 'TWD': { rate: 1, symbol: 'NT$', unit: 'TWD' }, 'JPY': { rate: 4.5, symbol: 'Â¥', unit: 'JPY' }, 'USD': { rate: 0.031, symbol: '$', unit: 'USD' } };
        let currentCurrency = 'TWD';
        let formula = [];
        let activeClaims = [];
        let radarChart, marketMapChart;

        const fabricsDB = [
            { id: "veocel", cost: 3.0, stats: { moist: 5, white: 1, aging: 0, repair: 2, oil: 0 }, name: { "zh-TW": "æ°´å‡çµ²é¢è†œ (VEOCEL)", "en-US": "Hydra Silk (VEOCEL)", "ja-JP": "ãƒã‚¤ãƒ‰ãƒ©ã‚·ãƒ«ã‚¯ (VEOCEL)" }, desc: { "zh-TW": "8um æ¥µè–„ï¼Œé«˜è¼‰æ¶²é‡ï¼Œæœå‡èˆ¬è†šæ„Ÿã€‚", "en-US": "8um ultra-thin, jelly-like texture.", "ja-JP": "8umæ¥µè–„ã€ã‚¼ãƒªãƒ¼ã®ã‚ˆã†ãªè³ªæ„Ÿã€‚" } },
            { id: "plant", cost: 1.5, stats: { moist: 3, white: 0, aging: 0, repair: 1, oil: 0 }, name: { "zh-TW": "è¶…æŸ”æ„Ÿé¢è†œ (Plant Fiber)", "en-US": "Soft Touch (Plant Fiber)", "ja-JP": "ã‚½ãƒ•ãƒˆã‚¿ãƒƒãƒ (æ¤ç‰©ç¹Šç¶­)" }, desc: { "zh-TW": "é«˜é€æ°£ã€é«˜æŸ”è»Ÿåº¦ï¼Œè¦ªæ°‘å…¥é–€æ¬¾ã€‚", "en-US": "High breathability, entry-level.", "ja-JP": "é«˜é€šæ°—æ€§ã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ¢ãƒ‡ãƒ«ã€‚" } },
            { id: "tencel", cost: 2.0, stats: { moist: 4, white: 1, aging: 0, repair: 1, oil: 0 }, name: { "zh-TW": "è¼•é€çµ²é¢è†œ (Tencel)", "en-US": "Lite Silk (Tencel)", "ja-JP": "ãƒ©ã‚¤ãƒˆã‚·ãƒ«ã‚¯ (ãƒ†ãƒ³ã‚»ãƒ«)" }, desc: { "zh-TW": "å …éŸŒçµ²æ»‘ï¼Œå®›å¦‚ç¬¬äºŒå±¤è‚Œè†šã€‚", "en-US": "Strong & silky, second-skin feel.", "ja-JP": "å¼·é­ã§æ»‘ã‚‰ã‹ã€‚" } },
            { id: "pet3d", cost: 2.5, stats: { moist: 2, white: 0, aging: 4, repair: 1, oil: 0 }, name: { "zh-TW": "ææ‹‰å½ˆåŠ›é¢è†œ (PET 3D)", "en-US": "Lifting 3D Mask", "ja-JP": "ãƒªãƒ•ãƒ†ã‚£ãƒ³ã‚°3Dãƒã‚¹ã‚¯" }, desc: { "zh-TW": "ç¨ç‰¹èºæ—‹çµæ§‹ï¼Œé›™å‘æ‹‰åŠ›ï¼Œç‰©ç†ææ‹‰æ•ˆæœã€‚", "en-US": "Spiral structure, two-way stretch, physical lifting.", "ja-JP": "ç‹¬è‡ªã®èºæ—‹æ§‹é€ ã€åŒæ–¹å‘ã‚¹ãƒˆãƒ¬ãƒƒãƒã€ç‰©ç†çš„ãƒªãƒ•ãƒˆã‚¢ãƒƒãƒ—ã€‚" } },
            { id: "nano", cost: 2.8, stats: { moist: 4, white: 1, aging: 2, repair: 3, oil: 0 }, name: { "zh-TW": "å¥ˆç±³é•·çº–é¢è†œ (Nano PET)", "en-US": "Nano Fiber Mask", "ja-JP": "ãƒŠãƒãƒ•ã‚¡ã‚¤ãƒãƒ¼ãƒã‚¹ã‚¯" }, desc: { "zh-TW": "2um å¥ˆç±³çº–ç¶­ï¼Œç£éµèˆ¬è²¼åˆï¼Œé«˜å¼·åº¦éŸŒæ€§ã€‚", "en-US": "2um nano fiber, magnet-like fit, high tenacity.", "ja-JP": "2umãƒŠãƒç¹Šç¶­ã€ç£çŸ³ã®ã‚ˆã†ãªå¯†ç€åŠ›ã€é«˜é­æ€§ã€‚" } },
            { id: "charcoal", cost: 2.0, stats: { moist: 1, white: 1, aging: 0, repair: 0, oil: 5 }, name: { "zh-TW": "ç«¹ç‚­é¢è†œ (Bamboo Charcoal)", "en-US": "Bamboo Charcoal Mask", "ja-JP": "ç«¹ç‚­ãƒ–ãƒ©ãƒƒã‚¯ãƒã‚¹ã‚¯" }, desc: { "zh-TW": "é«˜æº«é›ç‡’å¤©ç„¶é»‘ï¼Œå¸é™„é«’æ±™ï¼Œæ·¨åŒ–æ¯›å­”ã€‚", "en-US": "Natural charcoal, absorbs dirt, purifies pores.", "ja-JP": "å¤©ç„¶ç«¹ç‚­ã€æ±šã‚Œå¸ç€ã€æ¯›ç©´æµ„åŒ–ã€‚" } },
            { id: "hydrogel", cost: 12.0, stats: { moist: 5, white: 2, aging: 5, repair: 4, oil: 0 }, name: { "zh-TW": "å¾®å°å‡è† è†œ (Hydrogel)", "en-US": "Hydrogel Mask", "ja-JP": "ãƒã‚¤ãƒ‰ãƒ­ã‚²ãƒ«" }, desc: { "zh-TW": "é«˜å–®åƒ¹ï¼Œæ·±å±¤å°å…¥ï¼Œé©åˆé«˜éšæŠ—è€ç”¢å“ã€‚", "en-US": "Premium, deep penetration.", "ja-JP": "é«˜å˜ä¾¡ã€æ·±å±¤æµ¸é€ã€‚" } }
        ];

        const ingredients = [
            { name: "Butylene Glycol", cost: 120, stats: { moist: 2, white: 0, aging: 0, repair: 0, oil: 0 }, tags:['all'] },
            { name: "Niacinamide (B3)", cost: 850, stats: { moist: 1, white: 5, aging: 2, repair: 3, oil: 3 }, tags:['white','oil','aging'] },
            { name: "Azelaic Acid", cost: 2800, stats: { moist: 0, white: 3, aging: 0, repair: 0, oil: 5 }, tags:['oil'] },
            { name: "Tea Tree Oil", cost: 3200, stats: { moist: 0, white: 0, aging: 0, repair: 2, oil: 5 }, tags:['oil','repair'] },
            { name: "PDRN (DNA-Na)", cost: 15000, stats: { moist: 2, white: 0, aging: 5, repair: 5, oil: 0 }, tags:['aging','repair'] },
            { name: "Centella Asiatica", cost: 1800, stats: { moist: 1, white: 0, aging: 0, repair: 5, oil: 1 }, tags:['repair'] },
            { name: "Vit C (Ethyl Ascorbic)", cost: 4500, stats: { moist: 0, white: 5, aging: 3, repair: 0, oil: 0 }, tags:['white'] },
            { name: "Ceramide Complex", cost: 6500, stats: { moist: 4, white: 0, aging: 2, repair: 5, oil: 0 }, tags:['repair','moist'] },
            { name: "Sodium Hyaluronate", cost: 3000, stats: { moist: 5, white: 0, aging: 1, repair: 1, oil: 0 }, tags:['moist'] },
            { name: "Hexapeptide-8", cost: 12000, stats: { moist: 1, white: 0, aging: 5, repair: 0, oil: 0 }, tags:['aging'] }
        ];

        const productsDB = [
            { name: { "zh-TW": "æ·¨å…‰å¹³è¡¡é¢è†œ", "en-US": "Pure Balance Mask", "ja-JP": "ãƒ”ãƒ¥ã‚¢ãƒãƒ©ãƒ³ã‚¹ãƒã‚¹ã‚¯" }, key: "Azelaic Acid + Tea Tree", desc: { "zh-TW": "å¾®ç”Ÿæ…‹æ§æ²¹å¹³è¡¡ç³»çµ±", "en-US": "Micro-ecology balance system", "ja-JP": "ç¾è‚ŒèŒãƒãƒ©ãƒ³ã‚¹ã‚·ã‚¹ãƒ†ãƒ " }, img: "æ·¨å…‰.jpg" },
            { name: { "zh-TW": "æ†å…‰é€†é½¡é¢è†œ", "en-US": "Ageless Glow Mask", "ja-JP": "ã‚¨ã‚¤ã‚¸ãƒ¬ã‚¹ã‚°ãƒ­ã‚¦ãƒã‚¹ã‚¯" }, key: "PDRN + Peptides", desc: { "zh-TW": "æ·±å±¤è³¦æ´»ç·Šç·»é…æ–¹", "en-US": "Deep revitalizing formula", "ja-JP": "æ·±å±¤æ´»æ€§åŒ–å‡¦æ–¹" }, img: "æ†å…‰.jpg" },
            { name: { "zh-TW": "æŸ”å…‰ä¿®è­·é¢è†œ", "en-US": "Soft Repair Mask", "ja-JP": "ã‚½ãƒ•ãƒˆãƒªãƒšã‚¢ãƒã‚¹ã‚¯" }, key: "CICA + Ceramide", desc: { "zh-TW": "èˆ’ç·©ä¿®è­·å±éšœå¼·éŸŒ", "en-US": "Soothing barrier repair", "ja-JP": "é®é™ãƒãƒªã‚¢ä¿®å¾©" }, img: "æŸ”å…‰.jpg" },
            { name: { "zh-TW": "æ¥µå…‰ç…¥ç™½é¢è†œ", "en-US": "Aurora White Mask", "ja-JP": "ã‚ªãƒ¼ãƒ­ãƒ©ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¹ã‚¯" }, key: "Vit C + Glutathione", desc: { "zh-TW": "è‚Œè†šé€äº®å…‰æ¾¤å°ç­–", "en-US": "Radiance solution", "ja-JP": "é€æ˜æ„Ÿå¯¾ç­–" }, img: "æ¥µå…‰.jpg" },
            { name: { "zh-TW": "å‹»å…‰æ•´è‚Œé¢è†œ", "en-US": "Radiance Mask", "ja-JP": "ãƒ©ãƒ‡ã‚£ã‚¢ãƒ³ã‚¹ãƒã‚¹ã‚¯" }, key: "Collagen + HA", desc: { "zh-TW": "åŸºç¤æ»‹æ½¤æŸ”å«©", "en-US": "Essential hydration", "ja-JP": "åŸºç¤ä¿æ¹¿" }, img: "å‹»å…‰.jpg" }
        ];

        const competitorsDB = [
            { b: "Anua (KR)", p: "Azelaic Acid 15", k: "Azelaic, CICA", price: 25, volume: 85, cat: { "zh-TW": "æ§æ²¹èª¿ç†", "en-US": "Oil Control", "ja-JP": "çš®è„‚ã‚±ã‚¢" }, fb: { "zh-TW": "é®éœæ•ˆæœå¿«ï¼Œä½†ç²¾è¯æ¶²åå°‘ã€‚", "en-US": "Fast calming, but low serum amount.", "ja-JP": "é®é™ã¯æ—©ã„ãŒã€ç¾å®¹æ¶²ãŒå°‘ãªã‚ã€‚" } },
            { b: "Lululun (JP)", p: "Hydra-F", k: "Charcoal, Fullerene", price: 28, volume: 95, cat: { "zh-TW": "æ¯›å­”ç·Šç·»", "en-US": "Pore Firming", "ja-JP": "æ¯›ç©´å¼•ãç· ã‚" }, fb: { "zh-TW": "å‚™é•·ç‚­å¸ƒè†œæœè²¼ï¼ŒCPå€¼é«˜ã€‚", "en-US": "Charcoal sheet fits well. High CP value.", "ja-JP": "ç‚­ã‚·ãƒ¼ãƒˆãŒå¯†ç€ã€‚ã‚³ã‚¹ãƒ‘é«˜ã„ã€‚" } },
            { b: "Quality 1st", p: "Super VC100", k: "Vit C, Nanocapsules", price: 25, volume: 90, cat: { "zh-TW": "äº®ç™½æ¯›å­”", "en-US": "Brightening", "ja-JP": "ç¾ç™½æ¯›ç©´" }, fb: { "zh-TW": "ç¨å¾®æœ‰åˆºæ¿€æ„Ÿï¼Œæ•æ„Ÿè‚Œæ…ç”¨ã€‚", "en-US": "Slight tingling, caution for sensitive skin.", "ja-JP": "å°‘ã—ãƒ”ãƒªã¤ãã€æ•æ„Ÿè‚Œã¯æ³¨æ„ã€‚" } },
            { b: "Medicube", p: "PDRN Pink", k: "PDRN, Collagen", price: 120, volume: 40, cat: { "zh-TW": "é«˜éšä¿®è­·", "en-US": "Adv. Repair", "ja-JP": "é«˜åº¦ä¿®å¾©" }, fb: { "zh-TW": "æ•ˆæœé©šäººä½†åƒ¹æ ¼åé«˜ï¼Œé©åˆæ€¥æ•‘ã€‚", "en-US": "Amazing results but pricey. Good for SOS.", "ja-JP": "åŠ¹æœã¯å‡„ã„ãŒé«˜ã„ã€‚æ•‘æ€¥ç”¨ã«ã€‚" } },
            { b: "Torriden (KR)", p: "DIVE IN", k: "5D Hyaluronic", price: 60, volume: 75, cat: { "zh-TW": "æ·±å±¤ä¿æ¿•", "en-US": "Deep Moist", "ja-JP": "æ·±å±¤ä¿æ¹¿" }, fb: { "zh-TW": "éå¸¸æº«å’Œï¼Œé©åˆæ‰€æœ‰è†šè³ªã€‚", "en-US": "Very gentle, suitable for all skin types.", "ja-JP": "éå¸¸ã«ãƒã‚¤ãƒ«ãƒ‰ã€å…¨è‚Œè³ªå¯¾å¿œã€‚" } }
        ];

        function printReport() {
            updatePrintContent();
            window.print();
        }
        
        function updatePrintContent() {
            const t = translations[currentLang];
            const rate = exchangeRates[currentCurrency];
            const fabIdx = document.getElementById('fabricSelect').value || 0;
            const fab = fabricsDB[fabIdx];
            
            document.getElementById('printPageTitle1').innerText = t.print_page_title1;
            document.getElementById('printPageTitle2').innerText = t.print_page_title2;
            document.getElementById('printSectionTitle1').innerText = t.print_section1;
            document.getElementById('printSectionTitle2').innerText = t.print_section2;
            
            const channel = document.getElementById('salesChannel').value;
            // Handle select options text for printing
            const channelSelect = document.getElementById('salesChannel');
            document.getElementById('printChannel').innerText = channelSelect.options[channelSelect.selectedIndex].text;
            
            document.getElementById('printRetailPrice').innerText = document.getElementById('retailPrice').value + ' ' + rate.unit;
            document.getElementById('printTargetCost').innerText = document.getElementById('targetCostDisplay').innerText;
            
            document.getElementById('printClaims').innerHTML = activeClaims.length > 0 
                ? activeClaims.map(c => `<span class="print-tag">${t.claims[c]}</span>`).join('')
                : `<span style="color: #999; font-size: 11px;">å°šæœªé¸æ“‡</span>`;
            
            document.getElementById('printFabric').innerText = fab.name[currentLang];
            document.getElementById('printFabricDesc').innerText = fab.desc[currentLang];
            
            let formulaHtml = `<tr><td>WATER (Aqua)</td><td style="text-align: right;">${document.getElementById('waterPct').innerText}%</td><td style="text-align: right;">-</td></tr>`;
            formula.forEach(item => {
                formulaHtml += `<tr><td>${item.name}</td><td style="text-align: right;">${item.pct.toFixed(1)}%</td><td style="text-align: right;">${rate.symbol}${(item.cost * item.pct / 100 * 0.025 * rate.rate).toFixed(2)}</td></tr>`;
            });
            formulaHtml += `<tr style="background: #E8F3EB !important;"><td><strong>è†œå¸ƒ Fabric: ${fab.name[currentLang]}</strong></td><td style="text-align: right;">-</td><td style="text-align: right;">${rate.symbol}${(fab.cost * rate.rate).toFixed(2)}</td></tr>`;
            document.getElementById('printFormulaBody').innerHTML = formulaHtml;
            
            document.getElementById('printFinalCost').innerText = document.getElementById('finalCost').innerText;
            document.getElementById('printAiSuggestion').innerText = document.getElementById('aiSuggestion').innerText;
            
            const dateStr = new Date().toLocaleDateString(currentLang === 'zh-TW' ? 'zh-TW' : currentLang === 'ja-JP' ? 'ja-JP' : 'en-US');
            document.getElementById('printDate1').innerText = dateStr;
            document.getElementById('printDate2').innerText = dateStr;
            
            document.getElementById('printProductGrid').innerHTML = productsDB.map(p => `
                <div class="print-product">
                    <img src="${p.img}" alt="${p.name[currentLang]}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2D4A3E/FFFFFF?text=Image+Not+Found'">
                    <h4>${p.name[currentLang]}</h4>
                    <p>${p.desc[currentLang]}</p>
                    <div class="key">Key: ${p.key}</div>
                </div>`).join('');
        }

        window.onload = function() {
            initCharts();
            populateSelect();
            changeLanguage('zh-TW');
            document.getElementById('fabricSelect').value = "0"; 
            recalc();
        };

        function changeLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];

            // 1. Static Text Updates
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) el.innerText = t[key];
            });

            // 2. Specific Nav Titles Logic (handled by data-i18n now, but refresh active tab titles)
            const activeNav = document.querySelector('.nav-item.active');
            if(activeNav) {
                const id = activeNav.getAttribute('onclick').match(/'([^']+)'/)[1];
                 const titles = {
                    'lab': [t.title_lab, t.desc_lab], 
                    'market': [t.title_market, t.desc_market], 
                    'products': [t.title_assets, t.desc_assets]
                };
                if(titles[id]){
                    document.getElementById('pageTitle').innerText = titles[id][0];
                    document.getElementById('pageDesc').innerText = titles[id][1];
                }
            }

            populateFabricSelect();
            renderClaims();
            renderProducts();
            renderMarketTable();
            updateAiSuggestion();
            updateMarketInsights();
            updateChartsLang();
            recalc();
        }

        function switchTab(id, el) {
            document.querySelectorAll('[id^="tab-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            const t = translations[currentLang];
            const titles = {
                'lab': [t.title_lab, t.desc_lab], 
                'market': [t.title_market, t.desc_market], 
                'products': [t.title_assets, t.desc_assets]
            };
            document.getElementById('pageTitle').innerText = titles[id][0];
            document.getElementById('pageDesc').innerText = titles[id][1];

            if (id === 'market' && marketMapChart) {
                setTimeout(() => {
                    marketMapChart.resize();
                    marketMapChart.update();
                }, 50);
            }
        }

        function populateFabricSelect() {
            const sel = document.getElementById('fabricSelect');
            const currentVal = sel.value || "0";
            sel.innerHTML = fabricsDB.map((f, i) => `<option value="${i}">${f.name[currentLang]}</option>`).join('');
            sel.value = currentVal;
            document.getElementById('fabricDesc').innerText = fabricsDB[sel.value || 0].desc[currentLang];
        }

        function renderClaims() {
            const container = document.getElementById('claimsContainer');
            const t = translations[currentLang];
            const claimKeys = ['oil', 'moist', 'white', 'aging', 'repair'];
            
            container.innerHTML = claimKeys.map(k => {
                const isSelected = activeClaims.includes(k) ? 'selected' : '';
                return `<span class="tag-select ${isSelected}" onclick="toggleClaim(this, '${k}')">${t.claims[k]}</span>`;
            }).join('');
        }

        function renderProducts() {
            document.getElementById('productGrid').innerHTML = productsDB.map(p => `
                <div class="card border-t-4 border-yiyu-primary">
                    <img src="${p.img}" alt="${p.name[currentLang]}" class="w-full h-48 object-cover rounded-md mt-3 mb-2" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2D4A3E/FFFFFF?text=Image+Not+Found'">
                    <h3 class="font-bold text-yiyu-base text-lg">${p.name[currentLang]}</h3>
                    <p class="text-xs text-gray-500 mt-2">${p.desc[currentLang]}</p>
                    <p class="mt-4 pt-4 border-t text-xs text-gray-400">Key: ${p.key}</p>
                </div>`).join('');
        }

        function renderMarketTable() {
            const tbody = document.getElementById('competitorTable');
            const rate = exchangeRates[currentCurrency];
            const t = translations[currentLang];
            tbody.innerHTML = competitorsDB.map(c => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                    <td class="p-3 pl-4 font-medium text-gray-700">${c.b}<div class="text-xs text-gray-400">${c.p}</div></td>
                    <td class="p-3"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium">${c.cat[currentLang]}</span></td>
                    <td class="p-3 text-xs text-yiyu-primary font-bold">${c.k}</td>
                    <td class="p-3 text-xs text-gray-500 italic">"${c.fb[currentLang]}"</td>
                    <td class="p-3 text-right pr-4 font-mono font-bold text-gray-600">${rate.symbol}${(c.price*rate.rate).toFixed(0)}</td>
                </tr>`).join('');
        }

        function toggleClaim(el, claim) {
            el.classList.toggle('selected');
            if(activeClaims.includes(claim)) activeClaims = activeClaims.filter(c=>c!==claim);
            else activeClaims.push(claim);
            
            updateAiSuggestion();
            updateMarketInsights();
        }

        function updateAiSuggestion() {
            const box = document.getElementById('aiSuggestion');
            const t = translations[currentLang];
            if(activeClaims.length === 0) { box.innerText = t.ai_waiting; return; }
            let hits = ingredients.filter(ing => activeClaims.some(c => ing.tags.includes(c)));
            let uniqueHits = [...new Set(hits.map(h => h.name.split(' ')[0]))];
            box.innerHTML = `${t.ai_prefix}<span class="font-bold text-yiyu-primary">${uniqueHits.join(', ')}</span>`;
        }

        function updateMarketInsights() {
            const kwContainer = document.getElementById('marketKeywords');
            const gapContainer = document.getElementById('marketGap');
            const stratContainer = document.getElementById('marketStrategy');
            const focusLabel = document.getElementById('currentFocus');
            const t = translations[currentLang];

            if(activeClaims.length === 0) {
                focusLabel.innerText = "--";
                kwContainer.innerHTML = `<span class="text-xs text-gray-400">${t.msg_select_claim}</span>`;
                gapContainer.innerHTML = `<i class="fas fa-search text-gray-300 mr-1"></i> ${t.msg_waiting_param}`;
                stratContainer.innerText = "--";
                return;
            }

            // Using hardcoded DB for insights to avoid complex object reconstruction, 
            // but in a real app this should be in the DB variable above.
            // Re-declaring here for safety as it was in original code but might be missing in context.
            const insightsData = {
                'oil': {
                    focus: { "zh-TW": 'æ§æ²¹/æ²¹ç—˜è‚Œ', "en-US": 'Oil Control/Acne', "ja-JP": 'çš®è„‚ã‚±ã‚¢/ãƒ‹ã‚­ãƒ“è‚Œ' },
                    keywords: { 
                        "zh-TW": ['#æ¸…çˆ½ä¸é»', '#æ¯›å­”æ”¶æ–‚', '#å»æ²¹å…‰', '#ä¸è‡´ç²‰åˆº', '#é®éœé€€ç´…'],
                        "en-US": ['#Non-Sticky', '#PoreRefining', '#MatteFinish', '#Non-Comedogenic', '#Calming'],
                        "ja-JP": ['#ã•ã£ã±ã‚Š', '#æ¯›ç©´å¼•ãç· ã‚', '#ãƒ†ã‚«ãƒªé˜²æ­¢', '#ãƒãƒ³ã‚³ãƒ¡ãƒ‰', '#é®é™']
                    },
                    gap: { 
                        "zh-TW": 'ç›®å‰å¸‚å ´ç¼ºä¹ã€Œé«˜å–®åƒ¹ä¸”å…·ä¿®è­·åŠ›ã€çš„æ§æ²¹ç”¢å“ï¼Œå¤šæ•¸ç”¢å“éæ–¼å»‰åƒ¹ä¸”åˆºæ¿€ã€‚',
                        "en-US": 'Market lacks premium oil-control products with repair benefits; most are cheap and harsh.',
                        "ja-JP": 'é«˜ç´šã‹ã¤ä¿®å¾©åŠ›ã®ã‚ã‚‹çš®è„‚ã‚±ã‚¢è£½å“ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å¤šãã¯å®‰ä¾¡ã§åˆºæ¿€ãŒå¼·ã„ã§ã™ã€‚'
                    },
                    strategy: { 
                        "zh-TW": 'å»ºè­°å¼·èª¿ã€Œé…¸é¡æº«å’Œç…¥è†šã€èˆ‡ã€Œå±éšœä¿®è­·ã€ä¸¦é‡ï¼Œåˆ‡å…¥ä¸­é«˜éšå¸‚å ´ã€‚',
                        "en-US": 'Emphasize "Gentle Acid Peeling" + "Barrier Repair" to target the premium segment.',
                        "ja-JP": 'ã€Œãƒã‚¤ãƒ«ãƒ‰ãƒ”ãƒ¼ãƒªãƒ³ã‚°ã€ã¨ã€Œãƒãƒªã‚¢ä¿®å¾©ã€ã‚’å¼·èª¿ã—ã€ä¸­é«˜ç´šå¸‚å ´ã‚’ç‹™ã†ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚'
                    }
                },
                'moist': {
                    focus: { "zh-TW": 'ä¿æ¿•/ä¹¾è‚Œ', "en-US": 'Hydration/Dry Skin', "ja-JP": 'ä¿æ¹¿/ä¹¾ç‡¥è‚Œ' },
                    keywords: { 
                        "zh-TW": ['#çˆ†æ°´æ„Ÿ', '#é•·æ•ˆé–æ°´', '#ä¸æ‚¶ç—˜', '#å¦å‰æ€¥æ•‘', '#æ»²é€å¿«'],
                        "en-US": ['#BurstingWater', '#LongLasting', '#Breathable', '#Pre-Makeup', '#FastAbsorb'],
                        "ja-JP": ['#æ°´å…‰è‚Œ', '#é•·æ™‚é–“ä¿æ¹¿', '#é–‰å¡æ„Ÿãªã—', '#åŒ–ç²§ãƒãƒª', '#é«˜æµ¸é€']
                    },
                    gap: { 
                        "zh-TW": 'ä¿æ¿•å¸‚å ´é£½å’Œï¼Œç¼ºå£åœ¨æ–¼ã€Œé‡å°æ¥µç«¯æ°£å€™ã€æˆ–ã€Œé†«ç¾è¡“å¾Œã€çš„é«˜æ©Ÿèƒ½ä¿æ¿•ã€‚',
                        "en-US": 'Market saturated. Opportunity in "Extreme Climate" or "Post-Procedure" hydration.',
                        "ja-JP": 'ä¿æ¹¿å¸‚å ´ã¯é£½å’ŒçŠ¶æ…‹ã€‚ã€Œæ¥µç«¯ãªæ°—å€™ã€ã‚„ã€Œæ–½è¡“å¾Œã€å‘ã‘ã®é«˜æ©Ÿèƒ½ä¿æ¹¿ã«ãƒãƒ£ãƒ³ã‚¹ã‚ã‚Šã€‚'
                    },
                    strategy: { 
                        "zh-TW": 'é¿é–‹åƒ¹æ ¼æˆ°ï¼Œæ”¹èµ°ã€Œæˆåˆ†é»¨ã€è·¯ç·šï¼Œå¼·èª¿å¤šé‡ç»å°¿é…¸æˆ–ç¥ç¶“é†¯èƒºçš„é«˜æ¿ƒåº¦æ·»åŠ ã€‚',
                        "en-US": 'Avoid price wars. Target "Ingredient Junkies" with high-conc. Ceramides/Hyaluronic Acid.',
                        "ja-JP": 'ä¾¡æ ¼ç«¶äº‰ã‚’é¿ã‘ã€ã€Œæˆåˆ†é‡è¦–ã€å±¤ã«å‘ã‘ã€é«˜æ¿ƒåº¦ã‚»ãƒ©ãƒŸãƒ‰ã‚„ãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã€‚'
                    }
                },
                'white': {
                    focus: { "zh-TW": 'ç¾ç™½/æš—æ²‰', "en-US": 'Brightening/Dullness', "ja-JP": 'ç¾ç™½/ãã™ã¿' },
                    keywords: {
                        "zh-TW": ['#æäº®æœ‰æ„Ÿ', '#æ·¡åŒ–ç—˜å°', '#ä¸åé»‘', '#æº«å’Œäº®ç™½', '#ç™¼å…‰è‚Œ'],
                        "en-US": ['#Glow', '#FadeSpots', '#Non-Darkening', '#GentleBrightening', '#Radiance'],
                        "ja-JP": ['#ãƒˆãƒ¼ãƒ³ã‚¢ãƒƒãƒ—', '#ãƒ‹ã‚­ãƒ“è·¡ã‚±ã‚¢', '#ä½åˆºæ¿€', '#é€æ˜æ„Ÿ', '#ç™ºå…‰è‚Œ']
                    },
                    gap: {
                        "zh-TW": 'æ¶ˆè²»è€…å®³æ€•ç¾ç™½æˆåˆ†åˆºæ¿€ï¼Œç¼ºä¹ã€Œæ•æ„Ÿè‚Œä¹Ÿèƒ½ç”¨çš„é«˜æ•ˆç¾ç™½ã€ç”¢å“ã€‚',
                        "en-US": 'Consumers fear irritation. Lack of "Effective Brightening for Sensitive Skin".',
                        "ja-JP": 'ç¾ç™½æˆåˆ†ã®åˆºæ¿€ãŒæ‡¸å¿µç‚¹ã€‚ã€Œæ•æ„Ÿè‚Œã§ã‚‚ä½¿ãˆã‚‹é«˜æ©Ÿèƒ½ç¾ç™½ã€ãŒä¸è¶³ã€‚'
                    },
                    strategy: {
                        "zh-TW": 'çµåˆèˆ’ç·©æˆåˆ† (ç©é›ªè‰) èˆ‡ç¾ç™½æˆåˆ†ï¼Œä¸»æ‰“ã€Œæº«å’Œé«˜æ•ˆã€ã€‚',
                        "en-US": 'Combine soothing agents (Cica) with brighteners. Claim "Gentle & Effective".',
                        "ja-JP": 'é®é™æˆåˆ†ï¼ˆCICAï¼‰ã¨ç¾ç™½æˆåˆ†ã‚’çµ„ã¿åˆã‚ã›ã€ã€Œå„ªã—ãé«˜åŠ¹æœã€ã‚’è¨´æ±‚ã€‚'
                    }
                },
                'aging': {
                    focus: { "zh-TW": 'æŠ—è€/ç†Ÿé½¡', "en-US": 'Anti-Aging', "ja-JP": 'ã‚¨ã‚¤ã‚¸ãƒ³ã‚°ã‚±ã‚¢' },
                    keywords: {
                        "zh-TW": ['#æ’«å¹³ç´°ç´‹', '#ç·Šç·»æ‹‰æ', '#æ¾æ½¤æ„Ÿ', '#æ”¹å–„æ³•ä»¤ç´‹', '#ç†¬å¤œç¥å™¨'],
                        "en-US": ['#AntiWrinkle', '#Lifting', '#Plumping', '#LineReduction', '#NightRepair'],
                        "ja-JP": ['#ã‚·ãƒ¯æ”¹å–„', '#ãƒªãƒ•ãƒˆã‚¢ãƒƒãƒ—', '#ãƒãƒªæ„Ÿ', '#ã»ã†ã‚Œã„ç·š', '#å¾¹å¤œå¯¾ç­–']
                    },
                    gap: {
                        "zh-TW": 'é–‹æ¶å¸‚å ´ç¼ºä¹çœŸæ­£å«æœ‰æœ‰æ•ˆæ¿ƒåº¦ (å¦‚ PDRN, èƒœè‚½) çš„æŠ—è€é¢è†œã€‚',
                        "en-US": 'Mass market lacks anti-aging masks with effective concentrations (PDRN, Peptides).',
                        "ja-JP": 'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢å¸‚å ´ã«ã¯ã€æœ‰åŠ¹æ¿ƒåº¦ï¼ˆPDRNã€ãƒšãƒ—ãƒãƒ‰ç­‰ï¼‰ã‚’å«ã‚€è£½å“ãŒä¸è¶³ã€‚'
                    },
                    strategy: {
                        "zh-TW": 'ä½¿ç”¨é«˜å–®åƒ¹è†œå¸ƒ (ç”Ÿç‰©çº–ç¶­/å¾®å°)ï¼Œé…åˆé«˜æ¿ƒåº¦æ´»æ€§ç‰©ï¼Œæ‰“é€ æ——è‰¦ç´šç”¢å“ã€‚',
                        "en-US": 'Use premium fabric (Bio-cellulose) + high actives for a flagship product.',
                        "ja-JP": 'é«˜ç´šã‚·ãƒ¼ãƒˆï¼ˆãƒã‚¤ã‚ªã‚»ãƒ«ãƒ­ãƒ¼ã‚¹ç­‰ï¼‰ã¨é«˜æ¿ƒåº¦æˆåˆ†ã§ã€ãƒ•ãƒ©ãƒƒã‚°ã‚·ãƒƒãƒ—è£½å“ã‚’æ§‹ç¯‰ã€‚'
                    }
                },
                'repair': {
                    focus: { "zh-TW": 'ä¿®è­·/æ•æ„Ÿ', "en-US": 'Repair/Sensitive', "ja-JP": 'ä¿®å¾©/æ•æ„Ÿè‚Œ' },
                    keywords: {
                        "zh-TW": ['#é€€ç´…ç¥é€Ÿ', '#èˆ’ç·©ä¹¾ç™¢', '#å¢åšè§’è³ª', '#ç„¡é…’ç²¾', '#æ›å­£æ•‘æ˜Ÿ'],
                        "en-US": ['#FastRednessRelief', '#SootheItch', '#BarrierBuild', '#AlcoholFree', '#SeasonalHelp'],
                        "ja-JP": ['#èµ¤ã¿é®é™', '#ç—’ã¿ç·©å’Œ', '#ãƒãƒªã‚¢å¼·åŒ–', '#ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒ•ãƒªãƒ¼', '#å­£ç¯€ã®å¤‰ã‚ã‚Šç›®']
                    },
                    gap: {
                        "zh-TW": 'é‡å°ã€Œå£ç½©è‚Œã€æˆ–ã€Œåˆ·é…¸å¾Œã€çš„ä¿®è­·éœ€æ±‚æŒçºŒä¸Šå‡ï¼Œä½†å°ˆç”¨ç”¢å“ä¸å¤šã€‚',
                        "en-US": 'Rising demand for "Maskne" or "Post-Acid" repair, but few dedicated products.',
                        "ja-JP": 'ã€Œãƒã‚¹ã‚¯è’ã‚Œã€ã‚„ã€Œãƒ”ãƒ¼ãƒªãƒ³ã‚°å¾Œã€ã®éœ€è¦å¢—ã ãŒã€å°‚ç”¨è£½å“ã¯å°‘ãªã„ã€‚'
                    },
                    strategy: {
                        "zh-TW": 'å¼·èª¿ã€Œæ¥µç°¡é…æ–¹ã€èˆ‡ã€Œç„¡æ·»åŠ ã€ï¼Œå»ºç«‹å°ˆæ¥­é†«ç¾å½¢è±¡ã€‚',
                        "en-US": 'Emphasize "Minimalist Formula" & "Free-From" to build a Derma-cosmetic image.',
                        "ja-JP": 'ã€ŒãƒŸãƒ‹ãƒãƒ«å‡¦æ–¹ã€ã¨ã€Œç„¡æ·»åŠ ã€ã‚’å¼·èª¿ã—ã€ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚ºã‚³ã‚¹ãƒ¡ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºç«‹ã€‚'
                    }
                }
            };

            const mainClaim = activeClaims[activeClaims.length - 1];
            const data = insightsData[mainClaim];

            if(data) {
                focusLabel.innerText = data.focus[currentLang];
                
                let kwHtml = '';
                const colors = ['bg-red-50 text-red-600', 'bg-blue-50 text-blue-600', 'bg-green-50 text-green-600', 'bg-purple-50 text-purple-600'];
                data.keywords[currentLang].forEach((k, i) => {
                    let colorClass = colors[i % colors.length];
                    kwHtml += `<span class="text-xs ${colorClass} px-2 py-1 rounded border border-opacity-50">${k}</span>`;
                });
                kwContainer.innerHTML = kwHtml;

                gapContainer.innerHTML = `<strong class="text-yiyu-secondary">Analysis:</strong> ${data.gap[currentLang]}`;
                stratContainer.innerHTML = data.strategy[currentLang];
            }
        }

        function populateSelect() {
            const sel = document.getElementById('ingredientSelector');
            ingredients.forEach((ing, i) => sel.innerHTML += `<option value="${i}">${ing.name}</option>`);
        }

        function addIngredient() {
            const idx = document.getElementById('ingredientSelector').value;
            if(idx === "") return;
            formula.push({...ingredients[idx], pct: 1.0}); 
            renderFormula();
            recalc();
        }

        function renderFormula() {
            const tbody = document.getElementById('formulaBody');
            let html = `<tr class="bg-yiyu-secondary/10"><td class="p-3 font-medium text-yiyu-base flex items-center gap-2"><i class="fas fa-tint text-yiyu-secondary"></i> WATER</td><td class="p-3 text-right text-gray-600" id="waterPct">100.0</td><td class="p-3 text-right text-gray-400">-</td><td></td></tr>`;
            formula.forEach((item, i) => {
                html += `
                    <tr class="border-b border-gray-50 group hover:bg-gray-50 transition-colors">
                        <td class="p-3 text-gray-700 font-medium">${item.name}</td>
                        <td class="p-3 text-right"><input type="number" step="0.1" value="${item.pct}" onchange="formula[${i}].pct=parseFloat(this.value);recalc()" class="w-16 text-right border border-gray-200 rounded p-1 outline-none focus:border-yiyu-primary bg-white"></td>
                        <td class="p-3 text-right text-xs text-gray-500 cost-cell font-mono pt-4" data-base="${(item.cost*item.pct/100).toFixed(1)}">0</td>
                        <td class="p-3 text-center"><button onclick="formula.splice(${i},1);renderFormula();recalc()" class="text-gray-300 hover:text-red-400 transition"><i class="fas fa-times"></i></button></td>
                    </tr>`;
            });
            tbody.innerHTML = html;
        }

        function recalc() {
            const rate = exchangeRates[currentCurrency];
            const fabIdx = document.getElementById('fabricSelect').value || 0;
            const fab = fabricsDB[fabIdx];

            let bulkCostKG = formula.reduce((s,i) => s+(i.cost*i.pct/100), 0);
            let fabCostSheet = fab.cost;
            let totalSheetCost = (bulkCostKG * 0.025) + fabCostSheet; 
            
            let channel = document.getElementById('salesChannel').value;
            let retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;
            let retailPriceTWD = retailPrice / rate.rate; 
            
            let marginRatio = 0.3; 
            if(channel === 'retail') marginRatio = 0.15; 
            if(channel === 'distributor') marginRatio = 0.20; 

            let targetCostTWD = retailPriceTWD * marginRatio;

            let totalPct = formula.reduce((s,i) => s+i.pct, 0);
            let water = Math.max(0, 100 - totalPct);
            document.getElementById('waterPct').innerText = water.toFixed(1);
            document.getElementById('totalPct').innerText = (totalPct + water).toFixed(1);
            document.getElementById('fabricDesc').innerText = fab.desc[currentLang];

            document.getElementById('finalCost').innerText = `${rate.symbol}${(totalSheetCost*rate.rate).toFixed(1)}`;
            document.getElementById('targetCostDisplay').innerText = `${rate.symbol}${(targetCostTWD*rate.rate).toFixed(1)}`;
            
            document.querySelectorAll('.cost-cell').forEach(c => {
                c.innerText = (parseFloat(c.dataset.base) * rate.rate).toFixed(1);
            });

            const warningBox = document.getElementById('costWarning');
            const diff = totalSheetCost - targetCostTWD;
            if(diff > 0) {
                warningBox.classList.remove('hidden');
                document.getElementById('overCostAmount').innerText = `+${rate.symbol}${(diff*rate.rate).toFixed(1)}`;
                document.getElementById('finalCost').classList.add('text-red-600');
            } else {
                warningBox.classList.add('hidden');
                document.getElementById('finalCost').classList.remove('text-red-600');
            }
            
            updateRadar();
        }

        function updateRadar() {
            if (!radarChart) return;
            let scores = { moist:0, white:0, aging:0, repair:0, oil:0 };
            let fStats = fabricsDB[document.getElementById('fabricSelect').value || 0].stats;
            for(let k in scores) scores[k] += fStats[k];
            formula.forEach(i => {
                for(let k in scores) scores[k] += i.stats[k] * (i.pct>0?1:0);
            });
            radarChart.data.datasets[0].data = Object.values(scores);
            radarChart.update();
        }

        function updateSystemCurrency() {
            currentCurrency = document.getElementById('currency').value;
            document.getElementById('currencySymbol').innerText = exchangeRates[currentCurrency].symbol;
            recalc();
            renderMarketTable();
            updateMarketMap();
        }
        
        function updateChartsLang() {
            const t = translations[currentLang];
            if(radarChart) {
                radarChart.data.labels = t.radar_labels;
                radarChart.update();
            }
            if(marketMapChart) {
                marketMapChart.options.scales.x.title.text = t.map_x;
                marketMapChart.options.scales.y.title.text = t.map_y;
                marketMapChart.update();
            }
        }

        function updateMarketMap() {
            if (!marketMapChart) return;
            const rate = exchangeRates[currentCurrency];
            const data = competitorsDB.map(c => ({
                x: c.price * rate.rate,
                y: c.volume,
                r: 8,
                label: c.b
            }));
            marketMapChart.data.datasets[0].data = data;
            updateChartsLang();
        }

        function initCharts() {
            const ctxR = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(ctxR, {
                type: 'radar',
                data: {
                    labels: ['ä¿æ¿•', 'ç¾ç™½', 'æŠ—è€', 'ä¿®è­·', 'æ§æ²¹'],
                    datasets: [{
                        label: 'Score',
                        data: [0,0,0,0,0],
                        backgroundColor: C_BG_RADAR,
                        borderColor: C_PRIMARY,
                        borderWidth: 2,
                        pointBackgroundColor: C_PRIMARY,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0, max: 12, ticks: { display: false },
                            pointLabels: { display: true, font: { size: 12, weight: 'bold' }, color: '#5F8D75' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            const ctxM = document.getElementById('marketMapChart').getContext('2d');
            marketMapChart = new Chart(ctxM, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Competitors',
                        data: [], 
                        backgroundColor: 'rgba(95, 141, 117, 0.6)',
                        borderColor: '#2D4A3E',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.raw.label + ': (Price: ' + context.raw.x.toFixed(0) + ')';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Price' },
                            grid: { color: '#f3f4f6' }
                        },
                        y: { 
                            title: { display: true, text: 'Market Volume' },
                            min: 0, max: 100,
                            grid: { color: '#f3f4f6' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
